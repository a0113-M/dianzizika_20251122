<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç”µå­å­—å¡</title>
    
    <!-- PWAå…¨å±é€‚é…è®¾ç½® -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f0f0f0">
    <!-- åµŒå…¥å¼Manifestï¼Œç”¨äºAndroid Chrome/Edgeæ·»åŠ åˆ°æ¡Œé¢åçš„å…¨å±æ˜¾ç¤º -->
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,{"name":"ç”µå­å­—å¡","short_name":"å­—å¡","start_url":".","display":"standalone","background_color":"#f0f0f0","theme_color":"#f0f0f0"}'>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f0f0f0; }
        *:focus { outline: none; }
        /* ç¦æ­¢é•¿æŒ‰å¼¹å‡ºç³»ç»Ÿèœå•ï¼Œæå‡Appä½“éªŒ */
        body { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        input, textarea { -webkit-user-select: auto; user-select: auto; }

        #desktop { width: 100vw; height: 100vh; background: #ffffff; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease, background-image 0.5s ease; background-size: cover; background-position: center; }
        .user-widget { display: flex; flex-direction: column; align-items: center; margin-bottom: 50px; }
        #time-widget { color: #333; text-shadow: none; margin-top: 20px; text-align: center; }
        #time-display { font-size: 48px; font-weight: 200; }
        #date-display { font-size: 16px; font-weight: 400; }
        #photo-container { width: 200px; height: 120px; background-color: #e9e9e9; border-radius: 18px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; color: rgba(0,0,0,0.4); font-size: 14px; transition: background-color 0.3s; }
        #photo-container:hover { background-color: #dcdcdc; }
        #photo-upload { display: none; }
        
        /* åº”ç”¨ç½‘æ ¼å¸ƒå±€ - è°ƒæ•´ä¸º2åˆ— */
        .app-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 80px); 
            gap: 40px; 
        }
        .app-icon { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; text-align: center; transition: transform 0.2s ease; }
        .app-icon:hover { transform: scale(1.1); }
        .app-icon .icon-placeholder { width: 60px; height: 60px; background-color: #f0f0f0; border-radius: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background-size: cover; background-position: center; }
        .app-icon .app-name { color: #555; font-size: 14px; font-weight: 500; text-shadow: none; }
        .app-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #f0f2f5; display: none; flex-direction: column; box-sizing: border-box; }
        .back-to-desktop { font-size: 14px; color: #888; cursor: pointer; z-index: 1002; } 
        
        #card-drawer-app { background-color: #fff; justify-content: space-between; align-items: center; padding: 20px; } 
        
        /* é¡¶éƒ¨æ é€šç”¨æ ·å¼ */
        .card-app-header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; box-sizing: border-box; z-index: 100; }

        #card-drawer-app .card-stack { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; position: relative; } 
        
        /* å¡ç‰‡æ ·å¼ - å›ºå®šä¸ºç™½è‰² */
        #card-drawer-app .card { 
            width: 85%; max-width: 340px; height: 70%; max-height: 450px; border-radius: 20px; 
            display: flex; justify-content: center; align-items: center; font-size: 28px; position: absolute; 
            transition: transform 0.35s ease, opacity 0.35s ease, background-color 0.3s; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            background-color: #ffffff; 
            color: #222; 
            border: 1px solid #eaeaea;
        } 

        .card.pos-top { transform: translateY(0) scale(1); z-index: 3; } 
        .card.pos-middle { transform: translateY(-10px) scale(0.98); z-index: 2; opacity: 0.8; } 
        .card.pos-bottom { transform: translateY(-20px) scale(0.96); z-index: 1; opacity: 0.6; } 
        .card.pos-offscreen { transform: translateX(-120%) rotate(-15deg) scale(1); opacity: 0; z-index: 0; }
        .card-stack.is-shuffling .card.pos-top { transform: translateX(-120%) rotate(-15deg) scale(1); opacity: 0; } 
        .card-stack.is-shuffling .card.pos-middle { transform: translateY(0) scale(1); z-index: 3; opacity: 1; } 
        .card-stack.is-shuffling .card.pos-bottom { transform: translateY(-10px) scale(0.98); z-index: 2; opacity: 0.8; } 
        
        #card-drawer-app .card-content { padding: 20px; word-break: break-all; text-align: center; font-weight: 500; letter-spacing: 1px; } 
        #card-drawer-app .card-actions { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 380px; padding: 10px 0 20px 0; }
        
        .char-selector-header-group { display: flex; align-items: center; gap: 8px; }
        .char-selector-header-group label { font-size: 13px; color: #888; }
        #card-char-selector { padding: 6px 10px; border-radius: 15px; border: 1px solid #ddd; font-size: 13px; background-color: #f5f5f5; outline: none; color: #333; }
        #card-drawer-app .question-area { width: 100%; display: flex; gap: 10px; margin-bottom: 15px; }
        #card-drawer-app #question-input { flex-grow: 1; padding: 12px; border-radius: 25px; border: 1px solid #ccc; font-size: 14px; }
        #card-drawer-app #ask-button { padding: 12px 20px; }
        #card-drawer-app .card-nav { width: 100%; display: flex; justify-content: space-around; align-items: flex-end; padding-bottom: 10px;} 
        #card-drawer-app .nav-button { cursor: pointer; text-align: center; } 
        #card-drawer-app .nav-button.shuffle, #card-drawer-app #ask-button { background-color: #222; color: white; padding: 12px 28px; border-radius: 25px; font-size: 16px; border: none; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); transition: background-color 0.3s, transform 0.2s; } 
        #card-drawer-app .nav-button.shuffle:active, #card-drawer-app #ask-button:active { transform: scale(0.95); }
        
        #card-drawer-app .nav-button.icon { width: auto; height: auto; background-color: transparent; border-radius: 0; display: flex; flex-direction: column; align-items: center; gap: 4px; color: #333; min-width: 50px; }
        #card-drawer-app .nav-button.icon svg { width: 28px; height: 28px; fill: #333; transition: transform 0.2s; }
        #card-drawer-app .nav-button.icon span { font-size: 11px; font-weight: 500; color: #555; }
        #card-drawer-app .nav-button.icon:hover svg { transform: scale(1.1); }

        .nav-button.shuffle:disabled, #ask-button:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; color: #666; }
        #question-input:disabled { background-color: #f0f0f0; cursor: not-allowed; }
        #draw-count-indicator { color: #e74c3c; font-size: 14px; margin-bottom: 10px; height: 16px; visibility: hidden; }
        
        /* éšæœºæŠ½å¡æ¨¡å¼æ ·å¼ - ä¼˜åŒ–ä¸ºæ°´å¹³æ’åˆ— */
        .random-mode-control { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 15px; 
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        .random-mode-control label { font-size: 14px; color: #555; white-space: nowrap; }
        .random-mode-control input { width: 50px; padding: 8px; border: 1px solid #ccc; border-radius: 6px; text-align: center; }
        .random-mode-control .draw-count-separator { color: #999; font-weight: bold; }
        
        /* å®šæ—¶æŠ½å¡è®¾ç½®æ ·å¼ */
        .auto-draw-control { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .auto-draw-control label { font-size: 14px; color: #555; }
        .auto-draw-control input { width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 6px; text-align: center; }
        
        /* å¼¹çª—æ ·å¼ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 1000; } 
        .modal-content { background-color: #fff; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.3); overflow-y: auto; } 
        .modal-content h3 { margin-top: 0; text-align: center; } 
        .modal-section { margin-bottom: 15px; flex-shrink: 0; } 
        .modal-section label { display: block; margin-bottom: 5px; font-size: 14px; color: #555; } 
        .modal-section select, .modal-section input[type="text"], .modal-section textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; } 
        .add-card-section { display: flex; gap: 10px; } 
        .add-card-section input { flex-grow: 1; } 
        .add-card-section button, .modal-actions button { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; background-color: #4285f4; color: white; font-size: 14px; white-space: nowrap; } 
        .add-card-section .secondary-btn { background-color: #5cb85c; } 
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; } 
        .modal-actions .close-btn { background-color: #ccc; color: #333; }
        #search-card-input { margin-bottom: 10px; } 
        #card-list-container { height: 25vh; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 6px; background-color: #f9f9f9; } 
        .card-item { display: flex; justify-content: space-between; align-items: center; background-color: #fff; padding: 8px 12px; border-radius: 4px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); } 
        .card-item span { word-break: break-all; } 
        .delete-card-btn { background: none; border: none; color: #ff4d4d; cursor: pointer; font-size: 18px; padding-left: 10px; } 
        #bulk-import-modal .modal-content { max-height: 80vh; overflow-y: hidden; } 
        #bulk-import-textarea { width: 100%; height: 200px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; padding: 8px; font-family: inherit; margin-bottom: 10px; }
        
        /* æ¶ˆæ¯æ—¶é—´æˆ³æ ·å¼ */
        .message-timestamp {
            font-size: 11px;
            color: #999;
            text-align: center;
            margin: 15px 0;
            position: relative;
        }

        .message-timestamp::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 1px;
            background-color: #eee;
            z-index: -1;
        }

        .message-timestamp span {
            background-color: #f8f9fa;
            padding: 0 12px;
        }

        .chat-message .bubble {
            position: relative;
            margin-bottom: 8px;
        }

        .chat-message.character .bubble::after {
            content: attr(data-timestamp);
            position: absolute;
            bottom: -16px;
            left: 15px;
            font-size: 10px;
            color: #999;
            white-space: nowrap;
        }

        .chat-message.user .bubble::after {
            content: attr(data-timestamp);
            position: absolute;
            bottom: -16px;
            right: 15px;
            font-size: 10px;
            color: #999;
            white-space: nowrap;
        }

        /* å¼•ç”¨å›å¤æ ·å¼ - ä¼˜åŒ–ä¸ºåœ¨æ¶ˆæ¯å†…å®¹ä¸‹æ–¹æ˜¾ç¤º */
        .chat-message .quote {
            background-color: rgba(0, 0, 0, 0.05);
            border-left: 3px solid #4285f4;
            padding: 6px 10px;
            margin-top: 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-message .quote .quote-text {
            opacity: 0.8;
        }

        /* æ‹ä¸€æ‹æ¶ˆæ¯æ ·å¼ */
        .pat-message {
            text-align: center;
            margin: 10px 0;
            font-size: 13px;
            color: #999;
            font-style: italic;
        }

        /* --- é€šè®¯Appæ ·å¼ --- */
        #chat-app { flex-direction: column; }
        
        /* èŠå¤©å¤´éƒ¨ - ä¼˜åŒ–å¸ƒå±€ */
        .chat-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 15px; 
            background-color: #f5f5f5; 
            border-bottom: 1px solid #e7e7e7; 
            position: relative; 
            z-index: 10; 
            height: 50px;
            box-sizing: border-box;
        }
        
        .chat-header-back { 
            font-size: 16px; 
            color: #4285f4; 
            cursor: pointer; 
            flex-shrink: 0;
        }
        
        .chat-header-title { 
            font-weight: 600; 
            flex-grow: 1; 
            margin: 0 15px;
            /* ç§»é™¤å±…ä¸­æ˜¾ç¤º */
            text-align: left;
        }
        
        .chat-header-actions { 
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        /* è§’è‰²é€‰æ‹©å™¨æ ·å¼ - ä¼˜åŒ–ä¸ºæ°´å¹³æ’åˆ— */
        .chat-character-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chat-character-selector label {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
        }
        
        #chat-character-selector {
            padding: 6px 10px;
            border-radius: 15px;
            border: 1px solid #ddd;
            font-size: 13px;
            background-color: #f5f5f5;
            outline: none;
            color: #333;
            min-width: 120px;
        }
        
        /* é€‰ä¸­æ¨¡å¼å¤´éƒ¨ (é»˜è®¤éšè—) */
        #chat-selection-header { 
            display: none; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 15px; 
            background-color: #333; 
            color: white; 
            border-bottom: 1px solid #222; 
            position: relative;
            z-index: 12; 
            height: 50px;
            box-sizing: border-box;
        }
        
        #selection-cancel-btn { cursor: pointer; padding: 5px 10px; font-size: 14px; color: #ddd; }
        #selection-title { font-weight: 500; font-size: 15px; flex-grow: 1; text-align: center; margin: 0 15px; }
        #selection-delete-btn { cursor: pointer; padding: 5px 10px; font-size: 14px; color: #ff6b6b; font-weight: bold; }

        .icon-btn { font-size: 24px; cursor: pointer; }
        .actions-menu { 
            display: none; 
            position: absolute; 
            top: 100%; 
            right: 15px; 
            background-color: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            list-style: none; 
            padding: 5px; 
            margin: 5px 0 0 0; 
            z-index: 11; 
            display: flex; 
            white-space: nowrap;
            flex-direction: column;
        }
        
        .actions-menu li { padding: 8px 10px; cursor: pointer; }
        .actions-menu li:hover { background-color: #f0f0f0; }
        
        /* èŠå¤©åŒºåŸŸ */
        .chat-body { 
            flex-grow: 1; 
            padding: 10px; 
            overflow-y: auto; 
            transition: background-image 0.5s ease; 
            background-size: cover; 
            background-position: center;
            /* ä¸ºè¾“å…¥æ¡†ç•™å‡ºæ›´å¤šç©ºé—´ */
            padding-bottom: 80px;
            height: calc(100vh - 130px); /* å‡å»å¤´éƒ¨å’Œè¾“å…¥åŒºåŸŸçš„é«˜åº¦ */
            box-sizing: border-box;
        }
        
        .chat-message { display: flex; margin-bottom: 15px; align-items: flex-end; position: relative; transition: opacity 0.2s; }
        .chat-message.user { justify-content: flex-end; }
        .chat-message .bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; word-wrap: break-word; transition: background-color 0.2s, transform 0.1s; }
        .chat-message.user .bubble { background-color: #dcf8c6; }
        .chat-message.character .bubble { background-color: #fff; }
        .chat-message .avatar { width: 36px; height: 36px; border-radius: 50%; background-color: #ccc; background-size: cover; background-position: center; margin-right: 10px; }
        
        /* é€‰ä¸­çŠ¶æ€æ ·å¼ */
        .chat-message.selected .bubble { background-color: #b3d4fc !important; transform: scale(0.98); border: 2px solid #4285f4; }
        .chat-message.selected.user .bubble { background-color: #a4c4f0 !important; }
        
        .chat-load-more-btn { text-align: center; font-size: 12px; color: #4285f4; padding: 10px; cursor: pointer; margin-bottom: 10px; background-color: rgba(255,255,255,0.6); border-radius: 15px; width: fit-content; margin-left: auto; margin-right: auto; }
        
        /* èŠå¤©è¾“å…¥åŒºåŸŸ - ä¼˜åŒ–å¸ƒå±€ï¼Œç¼©å°æŒ‰é’®ï¼Œä½¿ç”¨å›¾æ ‡ */
        .chat-input-area {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: #f5f5f5;
            border-top: 1px solid #e7e7e7;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            /* é€‚é…æ‰‹æœºå±å¹• */
            flex-wrap: nowrap;
            gap: 8px;
            box-sizing: border-box;
            height: auto;
            min-height: 70px;
            /* è§£å†³é”®ç›˜å¼¹å‡ºé—®é¢˜ */
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        
        .chat-input-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 20px;
            padding: 5px 15px;
            border: 1px solid #ddd;
            /* é€‚é…æ‰‹æœºå±å¹• */
            min-width: 0; /* å…è®¸ç¼©å° */
            order: 2;
        }
        
        .chat-input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 8px 0;
            font-size: 14px;
            background: transparent;
            /* é€‚é…æ‰‹æœºå±å¹• */
            min-width: 0; /* å…è®¸ç¼©å° */
        }
        
        /* å‘é€æŒ‰é’®æ”¹ä¸ºå›¾æ ‡æ ·å¼ */
        .chat-send-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
            /* é€‚é…æ‰‹æœºå±å¹• */
            white-space: nowrap;
            flex-shrink: 0;
            order: 3;
            font-size: 18px;
            padding: 0;
        }
        
        .chat-send-btn:hover {
            background-color: #3367d6;
        }
        
        .chat-send-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* ä¼˜åŒ–æŒ‰é’®æ ·å¼ - ä½¿ç”¨å›¾æ ‡ï¼Œç¼©å°å°ºå¯¸ */
        .multi-message-btn, .quote-btn, .pat-btn {
            background-color: transparent;
            color: #666;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
            /* é€‚é…æ‰‹æœºå±å¹• */
            flex-shrink: 0;
            order: 1;
            font-size: 18px;
            padding: 0;
        }
        
        .multi-message-btn:hover, .quote-btn:hover, .pat-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .multi-message-btn:disabled, .quote-btn:disabled, .pat-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            color: #999;
        }
        
        /* å¤šæ¡æ¶ˆæ¯çª—å£æ ·å¼ */
        .multi-message-window {
            position: absolute;
            bottom: 70px;
            left: 15px;
            right: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 100;
            display: none;
            flex-direction: column;
            max-height: 300px;
        }
        
        .multi-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .multi-message-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        
        .multi-message-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .multi-message-content {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            max-height: 200px;
        }
        
        .multi-message-item {
            display: flex;
            align-items: center;
            padding: 8px 5px;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .multi-message-item:last-child {
            border-bottom: none;
        }
        
        .multi-message-text {
            flex: 1;
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }
        
        .multi-message-delete {
            background: none;
            border: none;
            color: #ff4d4d;
            cursor: pointer;
            font-size: 16px;
            padding: 0 5px;
        }
        
        .multi-message-input-area {
            display: flex;
            gap: 8px;
        }
        
        .multi-message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            outline: none;
        }
        
        .multi-message-add-btn {
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .multi-message-send-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        /* æ–°å¢æœç´¢ç›¸å…³æ ·å¼ */
        .chat-search-container {
            display: none;
            padding: 10px 15px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #e7e7e7;
            align-items: center;
            gap: 10px;
        }
        
        .chat-search-input {
            flex-grow: 1;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        
        .chat-search-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #666;
            cursor: pointer;
            padding: 5px;
        }
        
        .search-results-info {
            padding: 5px 15px;
            background-color: #e3f2fd;
            color: #1565c0;
            font-size: 12px;
            text-align: center;
            border-bottom: 1px solid #bbdefb;
        }
        
        .chat-message.search-highlight {
            background-color: #fff9c4;
            border-radius: 8px;
            margin: 2px 0;
        }
        
        .chat-message.search-highlight .bubble {
            background-color: #fff59d !important;
        }
        
        .search-navigation {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 8px 15px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #e7e7e7;
        }
        
        .search-nav-btn {
            padding: 5px 10px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .search-nav-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* æ‰‹æœºå±å¹•é€‚é… */
        @media (max-width: 768px) {
            .chat-input-area {
                flex-direction: row;
                flex-wrap: nowrap;
                gap: 5px;
                height: auto;
                min-height: 70px;
                padding: 10px;
            }
            
            .chat-input-container {
                order: 2;
                margin-top: 0;
                flex-grow: 1;
            }
            
            .multi-message-btn, .quote-btn, .pat-btn {
                order: 1;
                flex: none;
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
            
            .chat-send-btn {
                order: 3;
                flex: none;
                margin-top: 0;
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .chat-header {
                padding: 10px;
            }
            
            .chat-character-selector {
                flex-direction: row;
                gap: 4px;
            }
            
            #chat-character-selector {
                min-width: 100px;
                font-size: 12px;
                padding: 4px 8px;
            }
            
            .chat-character-selector label {
                font-size: 12px;
            }
            
            .random-mode-control {
                flex-direction: row;
                gap: 5px;
            }
            
            .random-mode-control input {
                width: 40px;
                padding: 6px;
            }
        }
        
        /* è§’è‰²ç®¡ç†æ ·å¼ */
        #character-manager-modal .character-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        #character-manager-modal .character-item:hover { background-color: #f9f9f9; }
        #character-manager-modal .character-item:last-child { border-bottom: none; }
        #character-manager-modal .delete-char-btn { color: #ff4d4d; font-size: 18px; padding: 5px; }
        #edit-char-prompt { height: 150px; resize: vertical; }
        #edit-char-avatar-preview { width: 60px; height: 60px; border-radius: 50%; background-color: #eee; margin-top: 10px; cursor: pointer; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; font-size: 12px; color: #888; text-align: center; }
        #edit-char-avatar-upload { display: none; }
        
        /* è®¾ç½®åº”ç”¨æ ·å¼ */
        #settings-app { overflow-y: auto; }
        .settings-header-container { padding: 20px; }
        .settings-list { list-style: none; padding: 0; margin: 0; background-color: #fff; width: 100%; }
        .settings-item { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 16px; }
        .settings-item:hover { background-color: #f9f9f9; }
        .settings-item:last-child { border-bottom: none; }
        .settings-view { padding: 20px; box-sizing: border-box; width: 100%; display: none; flex-direction: column; gap: 20px; }
        .settings-form-group, .appearance-section { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .settings-form-group label, .appearance-section-title { display: block; margin-bottom: 10px; font-size: 16px; color: #333; font-weight: 500; }
        .settings-form-group input, .settings-form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .settings-button { padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; background-color: #4285f4; color: white; font-size: 15px; width: 100%; box-sizing: border-box; text-align: center; margin-top: 10px; }
        .settings-button:first-child { margin-top: 0; }
        .settings-button.secondary { background-color: #6c757d; }
        .settings-button.danger { background-color: #dc3545; }
        .settings-button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .appearance-wallpaper-controls { display: flex; align-items: center; gap: 10px; }
        .wallpaper-preview { width: 60px; height: 40px; border-radius: 4px; background-color: #eee; background-size: cover; background-position: center; border: 1px solid #ddd; }
        .appearance-controls { display: flex; gap: 10px; flex-grow: 1; }
        .appearance-controls .settings-button { width: auto; flex-grow: 1; margin-top: 0; }
        .app-icon-setting-item { display: flex; align-items: center; gap: 15px; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .app-icon-setting-item:last-child { border-bottom: none; }
        .icon-preview { width: 36px; height: 36px; border-radius: 8px; background-color: #f0f0f0; background-size: cover; background-position: center; border: 1px solid #eee; flex-shrink: 0; }
        .app-icon-setting-item span { font-size: 15px; flex-grow: 1; }

        /* --- çº¸æ¡Appæ ·å¼ --- */
        #notes-app-main-view { width: 100%; height: 100%; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px; position: relative; }
        .notes-control-group { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .notes-control-group label { display: block; margin-bottom: 10px; font-weight: 500; }
        .notes-control-group select, .notes-control-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        #note-user-input { height: 120px; resize: vertical; }
        .note-card-draw-area { display: flex; flex-direction: column; gap: 10px; }
        #note-draw-card-btn { width: 100%; background-color: #5cb85c; color: white; padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        #note-draw-card-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #note-drawn-cards-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .note-drawn-card-display { text-align: center; padding: 10px; background-color: #f0f0f0; border: 1px dashed #ccc; border-radius: 6px; font-size: 14px; color: #666; word-break: break-all; min-height: 2.5em; display: flex; align-items: center; justify-content: center; }
        #note-generate-btn { width: 100%; background-color: #4285f4; color: white; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: 500; cursor: pointer; transition: background-color 0.3s; margin-top: auto; flex-shrink: 0; }
        #note-generate-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        
        .note-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #fdfaf4; z-index: 1001; display: none; flex-direction: column; box-sizing: border-box; padding: 20px; }
        .note-view-back-btn { position: absolute; top: 20px; left: 20px; font-size: 14px; color: #888; cursor: pointer; z-index: 1002; }
        .note-view-content { margin-top: 40px; overflow-y: auto; height: 100%; }
        #note-reply-content { white-space: pre-wrap; word-wrap: break-word; font-size: 17px; line-height: 1.8em; color: #4a4a4a; background-image: linear-gradient(rgba(224, 210, 190, 0.5) .1em, transparent .1em); background-size: 100% 1.8em;}
        
        #note-history-list { list-style: none; padding: 0; margin: 0; }
        .note-history-item { background-color: #fff; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .note-history-item:hover { background-color: #f9f9f9; }
        .note-history-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .note-history-char-name { font-weight: 600; }
        .note-history-date { font-size: 12px; color: #999; }
        .note-history-preview { font-size: 14px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        #global-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.3s; pointer-events: none; opacity: 0;}
        #global-loading.active { opacity: 1; pointer-events: auto; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #333; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        /* ç´§æ€¥é‡ç½®æŒ‰é’® */
        #emergency-reset-btn { display: none; margin-top: 20px; padding: 10px 20px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3); }
        #emergency-reset-btn:hover { background-color: #c0392b; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- åŠ è½½é®ç½© -->
    <div id="global-loading" class="active">
        <div class="spinner"></div>
        <div id="loading-text">æ­£åœ¨è¿æ¥æ•°æ®åº“...</div>
        <button id="emergency-reset-btn">æ— æ³•è¿›å…¥ï¼Ÿå¼ºåˆ¶é‡ç½®æ•°æ®</button>
    </div>

    <!-- æ¡Œé¢HTMLç»“æ„ -->
    <div id="desktop">
        <div class="user-widget">
            <label for="photo-upload"><div id="photo-container">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</div></label>
            <input type="file" id="photo-upload" accept="image/*">
            <div id="time-widget">
                <div id="time-display"></div>
                <div id="date-display"></div>
            </div>
        </div>
        <div class="app-grid">
            <div class="app-icon" id="app-card-drawer"><div class="icon-placeholder"></div><span class="app-name">æŠ½å¡</span></div>
            <div class="app-icon" id="app-chat"><div class="icon-placeholder"></div><span class="app-name">é€šè®¯</span></div>
            <div class="app-icon" id="app-notes"><div class="icon-placeholder"></div><span class="app-name">çº¸æ¡</span></div>
            <div class="app-icon" id="app-settings"><div class="icon-placeholder"></div><span class="app-name">è®¾ç½®</span></div>
        </div>
    </div>
    
    <!-- æŠ½å¡åº”ç”¨ -->
    <div id="card-drawer-app" class="app-screen">
        <div class="card-app-header">
            <div class="back-to-desktop" id="card-back-btn"> &lt; è¿”å›æ¡Œé¢ </div>
            <div class="char-selector-header-group">
                <label for="card-char-selector">è§’è‰²:</label>
                <select id="card-char-selector"><option>åŠ è½½ä¸­...</option></select>
            </div>
        </div>

        <div class="card-stack" id="card-stack">
            <div class="card card-color-1 pos-top"><span class="card-content">è¯·å…ˆæé—®</span></div>
            <div class="card card-color-2 pos-middle"><span class="card-content"></span></div>
            <div class="card card-color-3 pos-bottom"><span class="card-content"></span></div>
        </div>
        <div class="card-actions">
            <!-- éšæœºæŠ½å¡æ¨¡å¼æ§åˆ¶ - ä¼˜åŒ–ä¸ºæ°´å¹³å¸ƒå±€ -->
            <div class="random-mode-control" id="random-mode-control">
                <label for="min-draw-count">æŠ½å¡æ•°:</label>
                <input type="number" id="min-draw-count" min="1" max="20" value="1">
                <span class="draw-count-separator">-</span>
                <input type="number" id="max-draw-count" min="1" max="20" value="4">
            </div>
            
            <div class="question-area">
                <input type="text" id="question-input" placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥é—®é¢˜...">
                <button id="ask-button" disabled>æé—®</button>
            </div>
            <div id="draw-count-indicator"></div>
            <div class="card-nav">
                <div class="nav-button icon" id="nav-chat-link-from-card"> 
                    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                    <span>è·³è½¬é€šè®¯</span> 
                </div>
                <div class="nav-button shuffle" id="shuffle-button"> æ´—ç‰Œ </div>
                <div class="nav-button icon" id="nav-deck-settings"> 
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
                    <span>ç‰Œç»„</span> 
                </div>
            </div>
        </div>
    </div>
    
    <!-- é€šè®¯Appçš„HTMLç»“æ„ -->
    <div id="chat-app" class="app-screen">
        <!-- æ­£å¸¸å¤´éƒ¨ - ä¼˜åŒ–å¸ƒå±€ -->
        <div class="chat-header" id="chat-header-normal">
            <span class="chat-header-back" id="chat-back-btn">&lt; è¿”å›</span>
            <span class="chat-header-title" id="chat-header-title">é€šè®¯</span>
            <div class="chat-header-actions">
                <!-- è§’è‰²é€‰æ‹©å™¨ - æ°´å¹³æ’åˆ— -->
                <div class="chat-character-selector">
                    <label for="chat-character-selector">è§’è‰²:</label>
                    <select id="chat-character-selector"><option>åŠ è½½ä¸­...</option></select>
                </div>
                <span class="icon-btn" id="chat-actions-btn">Â·Â·Â·</span>
                <ul class="actions-menu" id="chat-actions-menu" style="display: none;">
                    <li id="add-character-menu-btn">æ·»åŠ è§’è‰²</li>
                    <li id="manage-characters-menu-btn">ç®¡ç†è§’è‰²</li>
                    <li id="pat-settings-menu-btn">æ‹ä¸€æ‹è®¾ç½®</li>
                    <!-- æ–°å¢èœå•é¡¹ -->
                    <li id="clear-chat-history-btn">æ¸…ç©ºèŠå¤©è®°å½•</li>
                    <li id="start-new-conversation-btn">å¼€å¯æ–°å¯¹è¯</li>
                    <li id="search-chat-history-btn">æœç´¢èŠå¤©è®°å½•</li>
                </ul>
            </div>
        </div>
        
        <!-- é€‰ä¸­æ¨¡å¼å¤´éƒ¨ -->
        <div id="chat-selection-header">
            <div id="selection-cancel-btn">å–æ¶ˆ</div>
            <div id="selection-title">é€‰æ‹©æ¶ˆæ¯</div>
            <div id="selection-delete-btn">åˆ é™¤</div>
        </div>

        <!-- æœç´¢æ  -->
        <div class="chat-search-container" id="chat-search-container">
            <input type="text" class="chat-search-input" id="chat-search-input" placeholder="æœç´¢èŠå¤©è®°å½•...">
            <button class="chat-search-close" id="chat-search-close">Ã—</button>
        </div>
        
        <!-- æœç´¢ç»“æœä¿¡æ¯ -->
        <div class="search-results-info" id="search-results-info" style="display: none;"></div>
        
        <!-- æœç´¢å¯¼èˆª -->
        <div class="search-navigation" id="search-navigation" style="display: none;">
            <button class="search-nav-btn" id="search-prev-btn">ä¸Šä¸€ä¸ª</button>
            <button class="search-nav-btn" id="search-next-btn">ä¸‹ä¸€ä¸ª</button>
            <button class="search-nav-btn" id="search-exit-btn">é€€å‡ºæœç´¢</button>
        </div>

        <!-- å¤šæ¡æ¶ˆæ¯çª—å£ -->
        <div class="multi-message-window" id="multi-message-window">
            <div class="multi-message-header">
                <div class="multi-message-title">å¤šæ¡æ¶ˆæ¯</div>
                <button class="multi-message-close" id="multi-message-close">Ã—</button>
            </div>
            <div class="multi-message-content" id="multi-message-content">
                <!-- å¤šæ¡æ¶ˆæ¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="multi-message-input-area">
                <input type="text" class="multi-message-input" id="multi-message-input" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰å›è½¦æˆ–ç‚¹å‡»æ·»åŠ ">
                <button class="multi-message-add-btn" id="multi-message-add-btn">æ·»åŠ </button>
            </div>
            <button class="multi-message-send-btn" id="multi-message-send-btn">å‘é€å…¨éƒ¨</button>
        </div>

        <div class="chat-main">
            <div class="chat-body" id="chat-body"><p style="text-align: center; color: #aaa;">è¯·å…ˆæ·»åŠ å¹¶é€‰æ‹©ä¸€ä¸ªè§’è‰²</p></div>
            
            <!-- èŠå¤©è¾“å…¥åŒºåŸŸ - ä¼˜åŒ–æŒ‰é’®æ ·å¼ -->
            <div class="chat-input-area">
                <button class="pat-btn" id="chat-pat-btn" title="æ‹ä¸€æ‹">ğŸ‘‹</button>
                <button class="quote-btn" id="chat-quote-btn" title="å¼•ç”¨">ğŸ’¬</button>
                <button class="multi-message-btn" id="chat-multi-message-btn" title="å¤šæ¡æ¶ˆæ¯">ğŸ“</button>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                </div>
                <!-- å‘é€æŒ‰é’®æ”¹ä¸ºå›¾æ ‡ -->
                <button class="chat-send-btn" id="chat-send-btn" title="å‘é€å¹¶æŠ½å¡">âœˆï¸</button>
            </div>
        </div>
    </div>

    <!-- çº¸æ¡Appçš„HTMLç»“æ„ -->
    <div id="notes-app" class="app-screen">
        <div id="notes-app-main-view">
            <div class="card-app-header">
                <div class="back-to-desktop" id="notes-back-btn"> &lt; è¿”å›æ¡Œé¢ </div>
                <div class="app-header-right-icon" id="note-history-btn" style="position: static; margin: 0;">å†å²è®°å½•</div>
            </div>
            
            <div class="notes-control-group">
                <label for="note-char-selector">é€‰æ‹©äº¤æ¢çº¸æ¡çš„è§’è‰²:</label>
                <select id="note-char-selector"></select>
            </div>

            <div class="notes-control-group">
                <label for="note-user-input">å†™ä¸‹ä½ çš„å°çº¸æ¡:</label>
                <textarea id="note-user-input" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆå¼€å¿ƒçš„äº‹å—ï¼Ÿ..."></textarea>
            </div>

            <div class="notes-control-group">
                <label id="note-draw-card-label">ä¸ºè¿™æ¬¡äº¤æ¢æŠ½å–ä¸»é¢˜å¡:</label>
                <div class="note-card-draw-area">
                    <div id="note-drawn-cards-container">
                        <div class="note-drawn-card-display"></div>
                        <div class="note-drawn-card-display"></div>
                        <div class="note-drawn-card-display"></div>
                        <div class="note-drawn-card-display"></div>
                    </div>
                    <button id="note-draw-card-btn">æŠ½å–</button>
                </div>
            </div>

            <button id="note-generate-btn" disabled>ç”Ÿæˆå›ä¿¡</button>
        </div>

        <div id="note-reply-view" class="note-view">
            <div class="note-view-back-btn" id="note-reply-back-btn"> &lt; è¿”å› </div>
            <div class="note-view-content" id="note-reply-content-wrapper">
                <div id="note-reply-content"></div>
            </div>
        </div>

        <div id="note-history-view" class="note-view">
             <div class="note-view-back-btn" id="note-history-back-btn"> &lt; è¿”å› </div>
             <div class="note-view-content">
                <ul id="note-history-list"></ul>
             </div>
        </div>
    </div>

    <!-- è®¾ç½®åº”ç”¨ -->
    <div id="settings-app" class="app-screen">
        <div class="settings-header-container">
            <div class="back-to-desktop" id="settings-back-btn"> &lt; è¿”å›æ¡Œé¢ </div>
        </div>
        <ul class="settings-list" id="settings-list-main">
            <li class="settings-item" id="setting-api">APIè®¾ç½®</li>
            <li class="settings-item" id="setting-appearance">å¤–è§‚è®¾ç½®</li>
            <li class="settings-item" id="setting-font">å­—ä½“è®¾ç½®</li>
            <li class="settings-item" id="setting-backup">å¤‡ä»½/å¯¼å…¥æ•°æ®</li>
            <li class="settings-item" id="setting-feedback">åé¦ˆ/è®¸æ„¿</li>
        </ul>
        <div id="api-settings-view" class="settings-view">
            <div class="settings-form-group"><label for="api-url">URL</label><input type="text" id="api-url" placeholder="ä¾‹å¦‚: https://api.openai.com/v1"></div><div class="settings-form-group"><label for="api-key">å¯†é’¥</label><input type="password" id="api-key" placeholder="è¯·è¾“å…¥ä½ çš„API Key"></div><div class="settings-form-group"><label for="api-model-selector">å¯ç”¨æ¨¡å‹</label><select id="api-model-selector"><option>è¯·å…ˆæ‹‰å–æ¨¡å‹åˆ—è¡¨</option></select></div><button class="settings-button secondary" id="fetch-models-btn">æ‹‰å–æ¨¡å‹</button><button class="settings-button" id="save-api-settings-btn">ä¿å­˜è®¾ç½®</button>
        </div>
        <div id="appearance-settings-view" class="settings-view">
            <div class="appearance-section"><p class="appearance-section-title">æ¡Œé¢å£çº¸</p><div class="appearance-wallpaper-controls"><div id="desktop-wallpaper-preview" class="wallpaper-preview"></div><div class="appearance-controls"><button class="settings-button" id="upload-desktop-wallpaper-btn">ä¸Šä¼ </button><button class="settings-button danger" id="reset-desktop-wallpaper-btn">é‡ç½®</button></div></div><input type="file" id="desktop-wallpaper-upload" accept="image/*" style="display:none;"></div><div class="appearance-section"><p class="appearance-section-title">é€šè®¯å£çº¸</p><div class="appearance-wallpaper-controls"><div id="chat-wallpaper-preview" class="wallpaper-preview"></div><div class="appearance-controls"><button class="settings-button" id="upload-chat-wallpaper-btn">ä¸Šä¼ </button><button class="settings-button danger" id="reset-chat-wallpaper-btn">é‡ç½®</button></div></div><input type="file" id="chat-wallpaper-upload" accept="image/*" style="display:none;"></div><div class="appearance-section"><p class="appearance-section-title">åº”ç”¨å›¾æ ‡</p><div id="app-icon-settings-container"></div></div>
            <div class="appearance-section"><p class="appearance-section-title">å­—ä½“å¤§å°</p><div class="appearance-controls"><button class="settings-button" id="font-size-small">å°</button><button class="settings-button" id="font-size-medium">ä¸­</button><button class="settings-button" id="font-size-large">å¤§</button></div></div>
            <div class="appearance-section"><p class="appearance-section-title">é»˜è®¤æŠ½å¡è®¾ç½®</p>
                <div class="settings-form-group"><label for="default-min-draw-count">éšæœºæœ€å°æ¬¡æ•° (1-20):</label><input type="number" id="default-min-draw-count" min="1" max="20" value="1"></div>
                <div class="settings-form-group"><label for="default-max-draw-count">éšæœºæœ€å¤§æ¬¡æ•° (1-20):</label><input type="number" id="default-max-draw-count" min="1" max="20" value="4"></div>
                <button class="settings-button" id="save-default-draw-settings-btn">ä¿å­˜é»˜è®¤è®¾ç½®</button>
            </div>
            <!-- å®šæ—¶æŠ½å¡è®¾ç½® -->
            <div class="appearance-section"><p class="appearance-section-title">å®šæ—¶æŠ½å¡è®¾ç½®</p><div class="auto-draw-control"><label for="auto-draw-enabled">å¯ç”¨å®šæ—¶æŠ½å¡:</label><input type="checkbox" id="auto-draw-enabled"></div><div class="settings-form-group"><label for="auto-draw-interval">æŠ½å¡é—´éš” (åˆ†é’Ÿ):</label><input type="number" id="auto-draw-interval" min="1" max="1440" value="60"></div><div class="auto-draw-control"><label for="auto-draw-min-count">æœ€å°æŠ½å¡æ•°:</label><input type="number" id="auto-draw-min-count" min="0" max="10" value="0"></div><div class="auto-draw-control"><label for="auto-draw-max-count">æœ€å¤§æŠ½å¡æ•°:</label><input type="number" id="auto-draw-max-count" min="1" max="10" value="3"></div><button class="settings-button" id="save-auto-draw-settings-btn">ä¿å­˜å®šæ—¶è®¾ç½®</button></div>
            <!-- æ‹ä¸€æ‹è®¾ç½® -->
            <div class="appearance-section"><p class="appearance-section-title">æ‹ä¸€æ‹è®¾ç½®</p><div class="settings-form-group"><label for="user-pat-text">ç”¨æˆ·æ‹ä¸€æ‹æ–‡æœ¬:</label><input type="text" id="user-pat-text" placeholder="ä¾‹å¦‚: ä½ æ‹äº†æ‹å¯¹æ–¹"></div><div class="settings-form-group"><label for="character-pat-text">è§’è‰²æ‹ä¸€æ‹æ–‡æœ¬ (å¤šæ¡ï¼Œæ¯è¡Œä¸€ä¸ª):</label><textarea id="character-pat-text" rows="5" placeholder="ä¾‹å¦‚: å¯¹æ–¹æ‹äº†æ‹ä½ &#10;å¯¹æ–¹è§‰å¾—ä½ å¾ˆå¯çˆ±&#10;å¯¹æ–¹è½»è½»æ‹äº†æ‹ä½ "></textarea></div><button class="settings-button" id="save-pat-settings-btn">ä¿å­˜æ‹ä¸€æ‹è®¾ç½®</button></div>
        </div>
        <div id="font-settings-view" class="settings-view">
             <div class="settings-form-group"><label for="font-url">å­—ä½“URL</label><input type="text" id="font-url" placeholder="ç²˜è´´å­—ä½“çš„URL (e.g., .woff2)"></div><button class="settings-button" id="apply-font-btn">åº”ç”¨å­—ä½“</button><button class="settings-button danger" id="reset-font-btn">æ¢å¤é»˜è®¤å­—ä½“</button>
        </div>
        <div id="backup-settings-view" class="settings-view">
            <div class="appearance-section">
                <button class="settings-button" id="backup-data-btn">å¤‡ä»½æ•°æ®</button>
                <button class="settings-button secondary" id="import-data-btn">å¯¼å…¥æ•°æ®</button>
                <input type="file" id="import-data-upload" accept=".json" style="display: none;">
                <button class="settings-button danger" id="reset-all-data-btn">é‡ç½®å…¨éƒ¨æ•°æ®</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—éƒ¨åˆ† -->
    <div id="deck-settings-modal" class="modal"><div class="modal-content"><h3>ç‰Œç»„è®¾ç½®</h3><div class="modal-section"><label for="deck-selector">é€‰æ‹©ç‰Œç»„è¿›è¡Œç¼–è¾‘:</label><select id="deck-selector"></select></div><div class="modal-section"><label for="current-deck-name">ç‰Œç»„åç§° (å¯ä¿®æ”¹æˆ–æ–°å»º):</label><input type="text" id="current-deck-name" placeholder="ä¸ºæ–°ç‰Œç»„å‘½å"></div><div class="modal-section"><label>å¡ç‰‡åˆ—è¡¨:</label><input type="text" id="search-card-input" placeholder="æœç´¢å¡ç‰‡..."><div id="card-list-container"></div></div><div class="modal-section add-card-section"><input type="text" id="new-card-input" placeholder="è¾“å…¥æ–°å¡ç‰‡å†…å®¹"><button id="add-card-btn">æ·»åŠ </button><button id="bulk-import-btn" class="secondary-btn">æ‰¹é‡å¯¼å…¥</button></div><div class="modal-actions"><button id="save-deck-btn">ä¿å­˜</button><button class="close-btn" id="close-modal-btn">å…³é—­</button></div></div></div>
    <div id="bulk-import-modal" class="modal"><div class="modal-content"><h3>æ‰¹é‡å¯¼å…¥å¡ç‰‡</h3><p style="font-size: 14px; color: #666; margin-top: 0;">è¯·å°†å­—è¯ç²˜è´´åˆ°ä¸‹æ–¹ï¼Œæ¯ä¸ªå­—è¯å ä¸€è¡Œã€‚</p><textarea id="bulk-import-textarea"></textarea><div class="modal-actions"><button id="confirm-bulk-import-btn">ç¡®è®¤å¯¼å…¥</button><button class="close-btn" id="cancel-bulk-import-btn">å–æ¶ˆ</button></div></div></div>
    <div id="character-manager-modal" class="modal"><div class="modal-content"><h3>ç®¡ç†è§’è‰²</h3><div class="modal-section"><label>ç‚¹å‡»è§’è‰²è¿›è¡Œç¼–è¾‘æˆ–åˆ é™¤:</label><div id="character-list"></div></div><div class="modal-actions"><button class="close-btn" id="close-char-manager-modal-btn">å…³é—­</button></div></div></div>
    <div id="character-editor-modal" class="modal"><div class="modal-content"><h3 id="char-editor-title">åˆ›å»ºæ–°è§’è‰²</h3><input type="hidden" id="editing-char-id"><div class="modal-section"><label for="edit-char-name">åå­—:</label><input type="text" id="edit-char-name"></div><div class="modal-section"><label for="edit-char-prompt">äººè®¾ (Prompt):</label><textarea id="edit-char-prompt" rows="6"></textarea></div><div class="modal-section"><label>å¤´åƒ:</label><label for="edit-char-avatar-upload"><div id="edit-char-avatar-preview">ç‚¹å‡»<br>ä¸Šä¼ </div></label><input type="file" id="edit-char-avatar-upload" accept="image/*"></div><div class="modal-actions"><button id="save-char-btn">ä¿å­˜</button><button class="close-btn" id="close-char-editor-modal-btn">å–æ¶ˆ</button></div></div></div>

    <script>
        // ============================================================
        //  SimpleDB
        // ============================================================
        const SimpleDB = {
            dbName: 'DesktopAppDB_v1',
            dbVersion: 1,
            db: null,

            open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('images')) db.createObjectStore('images');
                        if (!db.objectStoreNames.contains('data')) db.createObjectStore('data');
                    };
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (e) => reject('IndexedDB error: ' + e.target.error);
                    request.onblocked = () => reject('DB Blocked');
                });
            },

            async set(storeName, key, value) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject('DB not open');
                    const tx = this.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const req = store.put(value, key);
                    req.onsuccess = () => resolve(true);
                    req.onerror = () => reject(req.error);
                });
            },

            async get(storeName, key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject('DB not open');
                    const tx = this.db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const req = store.get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },

            async del(storeName, key) {
                 return new Promise((resolve, reject) => {
                    if (!this.db) return reject('DB not open');
                    const tx = this.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const req = store.delete(key);
                    req.onsuccess = () => resolve(true);
                    req.onerror = () => reject(req.error);
                });
            },
            
            async getAll(storeName) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject('DB not open');
                    const tx = this.db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const req = store.getAll(); 
                    const keyReq = store.getAllKeys(); 
                    
                    req.onsuccess = () => {
                        keyReq.onsuccess = () => {
                            const result = {};
                            req.result.forEach((val, i) => {
                                result[keyReq.result[i]] = val;
                            });
                            resolve(result);
                        }
                    };
                    req.onerror = () => reject(req.error);
                });
            }
        };

        // åŠ è½½æ§åˆ¶
        const loadingEl = document.getElementById('global-loading');
        const emergencyResetBtn = document.getElementById('emergency-reset-btn');
        
        function hideLoading() { 
            loadingEl.classList.remove('active'); 
            emergencyResetBtn.style.display = 'none';
        }
        function showLoading(text) { 
            if(text) document.getElementById('loading-text').textContent = text; 
            loadingEl.classList.add('active'); 
        }
        emergencyResetBtn.addEventListener('click', async () => {
            if(confirm("è¿™å°†æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®ï¼ˆåŒ…æ‹¬å¡ç»„ã€è§’è‰²ã€è®¾ç½®ï¼‰ä»¥ä¿®å¤å¡æ­»é—®é¢˜ã€‚ç¡®å®šå—ï¼Ÿ")) {
                localStorage.clear();
                indexedDB.deleteDatabase(SimpleDB.dbName);
                alert("æ•°æ®å·²é‡ç½®ï¼Œå³å°†åˆ·æ–°é¡µé¢...");
                location.reload();
            }
        });

        // --- åŸºç¡€Appå˜é‡å®šä¹‰ ---
        const desktop = document.getElementById('desktop'); 
        const cardDrawerApp = document.getElementById('card-drawer-app'); 
        const chatApp = document.getElementById('chat-app');
        const notesApp = document.getElementById('notes-app');
        const settingsApp = document.getElementById('settings-app'); 
        const appCardDrawerIcon = document.getElementById('app-card-drawer'); 
        const appChatIcon = document.getElementById('app-chat');
        const appNotesIcon = document.getElementById('app-notes');
        const appSettingsIcon = document.getElementById('app-settings'); 
        let navigationHistory = [];
        const settingsListMain = document.getElementById('settings-list-main');
        const apiSettingsView = document.getElementById('api-settings-view');
        const appearanceSettingsView = document.getElementById('appearance-settings-view');
        const fontSettingsView = document.getElementById('font-settings-view');
        const backupSettingsView = document.getElementById('backup-settings-view');
        
        function hideAllApps() { cardDrawerApp.style.display = 'none'; chatApp.style.display = 'none'; notesApp.style.display = 'none'; settingsApp.style.display = 'none'; }
        function hideAllSettingsViews() { apiSettingsView.style.display = 'none'; appearanceSettingsView.style.display = 'none'; fontSettingsView.style.display = 'none'; backupSettingsView.style.display = 'none'; }
        function showDesktop() { desktop.style.opacity = '1'; desktop.style.pointerEvents = 'auto'; hideAllApps(); navigationHistory = []; }
        function showCardDrawerApp() { desktop.style.opacity = '0'; desktop.style.pointerEvents = 'none'; hideAllApps(); cardDrawerApp.style.display = 'flex'; updateCardAppCharSelector(); checkGameState(); }
        function showChatApp(from) { desktop.style.opacity = '0'; desktop.style.pointerEvents = 'none'; hideAllApps(); chatApp.style.display = 'flex'; renderChatCharacterSelector(); if(from) navigationHistory.push(from); }
        function showNotesApp() { desktop.style.opacity = '0'; desktop.style.pointerEvents = 'none'; hideAllApps(); notesApp.style.display = 'flex'; prepareNotesApp(); }
        function showSettingsApp() { desktop.style.opacity = '0'; desktop.style.pointerEvents = 'none'; hideAllApps(); settingsApp.style.display = 'block'; hideAllSettingsViews(); settingsListMain.style.display = 'block'; document.getElementById('settings-back-btn').textContent = '< è¿”å›æ¡Œé¢'; }
        
        appCardDrawerIcon.addEventListener('click', showCardDrawerApp); 
        appChatIcon.addEventListener('click', () => showChatApp('desktop'));
        appNotesIcon.addEventListener('click', showNotesApp);
        appSettingsIcon.addEventListener('click', showSettingsApp); 
        document.getElementById('nav-chat-link-from-card').addEventListener('click', () => showChatApp('card_drawer'));
        document.getElementById('card-back-btn').addEventListener('click', showDesktop);
        document.getElementById('notes-back-btn').addEventListener('click', showDesktop);
        document.getElementById('settings-back-btn').addEventListener('click', () => { if (apiSettingsView.style.display === 'flex' || appearanceSettingsView.style.display === 'flex' || fontSettingsView.style.display === 'flex' || backupSettingsView.style.display === 'flex') { showSettingsApp(); } else { showDesktop(); } }); 
        document.getElementById('chat-back-btn').addEventListener('click', () => { 
            // åªæœ‰åœ¨éé€‰æ‹©æ¨¡å¼ä¸‹ï¼Œè¿”å›æŒ‰é’®æ‰ç”Ÿæ•ˆï¼Œé˜²æ­¢è¯¯è§¦
            if (!isChatSelectionMode) {
                const lastPage = navigationHistory.pop(); 
                if (lastPage === 'card_drawer') { showCardDrawerApp(); } else { showDesktop(); } 
            }
        });
        function openSettingsSubView(viewElement) { settingsListMain.style.display = 'none'; hideAllSettingsViews(); viewElement.style.display = 'flex'; document.getElementById('settings-back-btn').textContent = '< è¿”å›è®¾ç½®'; }
        document.getElementById('setting-api').addEventListener('click', () => openSettingsSubView(apiSettingsView));
        document.getElementById('setting-appearance').addEventListener('click', () => { openSettingsSubView(appearanceSettingsView); renderAppIconSettings(); });
        document.getElementById('setting-font').addEventListener('click', () => openSettingsSubView(fontSettingsView));
        document.getElementById('setting-backup').addEventListener('click', () => openSettingsSubView(backupSettingsView));
        // åé¦ˆ/è®¸æ„¿ æŒ‰é’®äº‹ä»¶
        document.getElementById('setting-feedback').addEventListener('click', () => {
            window.open('https://xhslink.com/m/2tfmmImt5p0', '_blank');
        });

        // --- API ---
        const apiUrlInput = document.getElementById('api-url'); const apiKeyInput = document.getElementById('api-key'); const apiModelSelector = document.getElementById('api-model-selector'); const fetchModelsBtn = document.getElementById('fetch-models-btn'); const saveApiSettingsBtn = document.getElementById('save-api-settings-btn'); let apiSettings = {};
        function loadApiSettings() { 
            const savedSettings = localStorage.getItem('apiSettings'); 
            if (savedSettings) { 
                apiSettings = JSON.parse(savedSettings); 
                apiUrlInput.value = apiSettings.url || ''; 
                apiKeyInput.value = apiSettings.apiKey || ''; 
                if (apiSettings.selectedModel) { apiModelSelector.innerHTML = `<option value="${apiSettings.selectedModel}">${apiSettings.selectedModel}</option>`; } 
            } 
        }
        saveApiSettingsBtn.addEventListener('click', () => { apiSettings = { url: apiUrlInput.value.trim(), apiKey: apiKeyInput.value.trim(), selectedModel: apiModelSelector.value }; localStorage.setItem('apiSettings', JSON.stringify(apiSettings)); alert('APIè®¾ç½®å·²ä¿å­˜ï¼'); });
        fetchModelsBtn.addEventListener('click', async () => { const url = apiUrlInput.value.trim(); const key = apiKeyInput.value.trim(); if (!url || !key) { alert('è¯·å…ˆå¡«å†™URLå’Œå¯†é’¥ï¼'); return; } const modelsUrl = url.endsWith('/v1') ? `${url}/models` : `${url}/v1/models`; fetchModelsBtn.disabled = true; fetchModelsBtn.textContent = 'æ­£åœ¨æ‹‰å–...'; try { const response = await fetch(modelsUrl, { method: 'GET', headers: { 'Authorization': `Bearer ${key}` } }); if (!response.ok) { throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${response.status}`); } const data = await response.json(); apiModelSelector.innerHTML = ''; if (data.data && data.data.length > 0) { data.data.forEach(model => { const option = new Option(model.id, model.id); apiModelSelector.add(option); }); if (apiSettings.selectedModel && data.data.some(m => m.id === apiSettings.selectedModel)) { apiModelSelector.value = apiSettings.selectedModel; } alert('æ¨¡å‹åˆ—è¡¨æ‹‰å–æˆåŠŸï¼'); } else { apiModelSelector.innerHTML = '<option>æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹</option>'; alert('æˆåŠŸè¿æ¥ï¼Œä½†æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹ã€‚'); } } catch (error) { console.error('æ‹‰å–æ¨¡å‹å¤±è´¥:', error); alert(`æ‹‰å–æ¨¡å‹å¤±è´¥: ${error.message}ã€‚`); apiModelSelector.innerHTML = '<option>æ‹‰å–å¤±è´¥</option>'; } finally { fetchModelsBtn.disabled = false; fetchModelsBtn.textContent = 'æ‹‰å–æ¨¡å‹'; } });
        async function callApi(systemPrompt, userPrompt) {
            const { url, apiKey, selectedModel } = apiSettings;
            if (!url || !apiKey || !selectedModel) { throw new Error("APIæœªé…ç½®ã€‚è¯·åœ¨è®¾ç½®ä¸­å¡«å†™URLã€å¯†é’¥å¹¶é€‰æ‹©æ¨¡å‹ã€‚"); }
            const completionsUrl = url.endsWith('/v1') ? `${url}/chat/completions` : `${url}/v1/chat/completions`;
            const response = await fetch(completionsUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify({ model: selectedModel, messages: [ { "role": "system", "content": systemPrompt }, { "role": "user", "content": userPrompt } ] }) });
            if (!response.ok) { const errorData = await response.json(); throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error.message}`); }
            const data = await response.json(); return data.choices[0].message.content;
        }

        // --- å¤–è§‚ ---
        const chatBody = document.getElementById('chat-body');
        const desktopWallpaperPreview = document.getElementById('desktop-wallpaper-preview'); 
        const chatWallpaperPreview = document.getElementById('chat-wallpaper-preview');
        const desktopWallpaperUpload = document.getElementById('desktop-wallpaper-upload');
        const chatWallpaperUpload = document.getElementById('chat-wallpaper-upload');
        const appIconSettingsContainer = document.getElementById('app-icon-settings-container');
        const apps = [ { id: 'app-card-drawer', name: 'æŠ½å¡' }, { id: 'app-chat', name: 'é€šè®¯' }, { id: 'app-notes', name: 'çº¸æ¡' }, { id: 'app-settings', name: 'è®¾ç½®' }];

        // å­—ä½“å¤§å°è®¾ç½®
        const fontSizeSmallBtn = document.getElementById('font-size-small');
        const fontSizeMediumBtn = document.getElementById('font-size-medium');
        const fontSizeLargeBtn = document.getElementById('font-size-large');
        
        function setFontSize(size) {
            document.documentElement.style.fontSize = size;
            localStorage.setItem('fontSize', size);
        }
        
        function loadFontSize() {
            const savedSize = localStorage.getItem('fontSize');
            if (savedSize) {
                document.documentElement.style.fontSize = savedSize;
            }
        }
        
        fontSizeSmallBtn.addEventListener('click', () => setFontSize('12px'));
        fontSizeMediumBtn.addEventListener('click', () => setFontSize('14px'));
        fontSizeLargeBtn.addEventListener('click', () => setFontSize('16px'));

        // é»˜è®¤æŠ½å¡è®¾ç½®
        const defaultMinDrawCountInput = document.getElementById('default-min-draw-count');
        const defaultMaxDrawCountInput = document.getElementById('default-max-draw-count');
        const saveDefaultDrawSettingsBtn = document.getElementById('save-default-draw-settings-btn');
        
        function loadDefaultDrawSettings() {
            const savedSettings = localStorage.getItem('defaultDrawSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                defaultMinDrawCountInput.value = settings.minCount || 1;
                defaultMaxDrawCountInput.value = settings.maxCount || 4;
                
                // åº”ç”¨åˆ°æŠ½å¡ç•Œé¢
                minDrawCountInput.value = settings.minCount || 1;
                maxDrawCountInput.value = settings.maxCount || 4;
            }
        }
        
        saveDefaultDrawSettingsBtn.addEventListener('click', () => {
            const settings = {
                minCount: parseInt(defaultMinDrawCountInput.value),
                maxCount: parseInt(defaultMaxDrawCountInput.value)
            };
            
            if (settings.minCount >= 1 && settings.minCount <= 20 && 
                settings.maxCount >= 1 && settings.maxCount <= 20 &&
                settings.minCount <= settings.maxCount) {
                
                localStorage.setItem('defaultDrawSettings', JSON.stringify(settings));
                
                // åº”ç”¨åˆ°æŠ½å¡ç•Œé¢
                minDrawCountInput.value = settings.minCount;
                maxDrawCountInput.value = settings.maxCount;
                
                alert('é»˜è®¤æŠ½å¡è®¾ç½®å·²ä¿å­˜ï¼');
            } else {
                alert('è¯·æ£€æŸ¥è¾“å…¥å€¼æ˜¯å¦æœ‰æ•ˆï¼æœ€å°æ¬¡æ•°ä¸èƒ½å¤§äºæœ€å¤§æ¬¡æ•°ã€‚');
            }
        });

        // å®šæ—¶æŠ½å¡è®¾ç½®
        const autoDrawEnabledCheckbox = document.getElementById('auto-draw-enabled');
        const autoDrawIntervalInput = document.getElementById('auto-draw-interval');
        const autoDrawMinCountInput = document.getElementById('auto-draw-min-count');
        const autoDrawMaxCountInput = document.getElementById('auto-draw-max-count');
        const saveAutoDrawSettingsBtn = document.getElementById('save-auto-draw-settings-btn');
        
        let autoDrawTimer = null;
        
        function loadAutoDrawSettings() {
            const savedSettings = localStorage.getItem('autoDrawSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                autoDrawEnabledCheckbox.checked = settings.enabled || false;
                autoDrawIntervalInput.value = settings.interval || 60;
                autoDrawMinCountInput.value = settings.minCount || 0;
                autoDrawMaxCountInput.value = settings.maxCount || 3;
                
                // å¯åŠ¨æˆ–åœæ­¢å®šæ—¶å™¨
                if (settings.enabled) {
                    startAutoDrawTimer(settings.interval);
                }
            }
        }
        
        saveAutoDrawSettingsBtn.addEventListener('click', () => {
            const settings = {
                enabled: autoDrawEnabledCheckbox.checked,
                interval: parseInt(autoDrawIntervalInput.value),
                minCount: parseInt(autoDrawMinCountInput.value),
                maxCount: parseInt(autoDrawMaxCountInput.value)
            };
            
            if (settings.interval >= 1 && settings.interval <= 1440 && 
                settings.minCount >= 0 && settings.minCount <= 10 && 
                settings.maxCount >= 1 && settings.maxCount <= 10 &&
                settings.minCount <= settings.maxCount) {
                
                localStorage.setItem('autoDrawSettings', JSON.stringify(settings));
                
                // å¯åŠ¨æˆ–åœæ­¢å®šæ—¶å™¨
                if (settings.enabled) {
                    startAutoDrawTimer(settings.interval);
                } else {
                    stopAutoDrawTimer();
                }
                
                alert('å®šæ—¶æŠ½å¡è®¾ç½®å·²ä¿å­˜ï¼');
            } else {
                alert('è¯·æ£€æŸ¥è¾“å…¥å€¼æ˜¯å¦æœ‰æ•ˆï¼æœ€å°æŠ½å¡æ•°ä¸èƒ½å¤§äºæœ€å¤§æŠ½å¡æ•°ã€‚');
            }
        });
        
        function startAutoDrawTimer(intervalMinutes) {
            stopAutoDrawTimer(); // å…ˆåœæ­¢ç°æœ‰çš„å®šæ—¶å™¨
            
            const intervalMs = intervalMinutes * 60 * 1000;
            autoDrawTimer = setInterval(() => {
                performAutoDraw();
            }, intervalMs);
            
            console.log(`å®šæ—¶æŠ½å¡å·²å¯åŠ¨ï¼Œé—´éš”: ${intervalMinutes}åˆ†é’Ÿ`);
        }
        
        function stopAutoDrawTimer() {
            if (autoDrawTimer) {
                clearInterval(autoDrawTimer);
                autoDrawTimer = null;
                console.log('å®šæ—¶æŠ½å¡å·²åœæ­¢');
            }
        }
        
        async function performAutoDraw() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„è§’è‰²å’Œç‰Œç»„
            if (Object.keys(characters).length === 0 || !currentActiveDeckName || !cardDecks[currentActiveDeckName] || cardDecks[currentActiveDeckName].length === 0) {
                console.log('å®šæ—¶æŠ½å¡: æ²¡æœ‰å¯ç”¨çš„è§’è‰²æˆ–ç‰Œç»„');
                return;
            }
            
            // è·å–è®¾ç½®
            const autoDrawSettings = JSON.parse(localStorage.getItem('autoDrawSettings') || '{}');
            const minCount = autoDrawSettings.minCount || 0;
            const maxCount = autoDrawSettings.maxCount || 3;
            
            // éšæœºå†³å®šæŠ½å¡æ•°é‡
            const drawCount = Math.floor(Math.random() * (maxCount - minCount + 1)) + minCount;
            
            if (drawCount === 0) {
                console.log('å®šæ—¶æŠ½å¡: æœ¬æ¬¡ä¸æŠ½å¡');
                return;
            }
            
            console.log(`å®šæ—¶æŠ½å¡: å‡†å¤‡æŠ½å– ${drawCount} å¼ å¡`);
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªè§’è‰²
            const charIds = Object.keys(characters);
            const randomCharId = charIds[Math.floor(Math.random() * charIds.length)];
            const character = characters[randomCharId];
            
            // è·å–ç‰Œç»„
            const deck = cardDecks[currentActiveDeckName];
            
            // ç”Ÿæˆæ—¶é—´æˆ³
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            // æŠ½å–å¡ç‰‡
            for (let i = 0; i < drawCount; i++) {
                const randIndex = Math.floor(Math.random() * deck.length);
                const drawnCard = deck[randIndex];
                
                // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ï¼ŒåŒ…å«æ—¶é—´æˆ³
                addMessageToChat(randomCharId, 'character', drawnCard, null, timestamp);
                
                // çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…ä¸€æ¬¡æ€§å‘é€å¤ªå¤šæ¶ˆæ¯
                await new Promise(resolve => setTimeout(resolve, 500));
            }            
            console.log(`å®šæ—¶æŠ½å¡: å·²ä¸ºè§’è‰² ${character.name} æŠ½å– ${drawCount} å¼ å¡`);
        }

        // æ‹ä¸€æ‹è®¾ç½®
        const userPatTextInput = document.getElementById('user-pat-text');
        const characterPatTextInput = document.getElementById('character-pat-text');
        const savePatSettingsBtn = document.getElementById('save-pat-settings-btn');
        
        let patSettings = {
            userPatText: "ä½ æ‹äº†æ‹å¯¹æ–¹",
            characterPatTexts: ["å¯¹æ–¹æ‹äº†æ‹ä½ ", "å¯¹æ–¹è§‰å¾—ä½ å¾ˆå¯çˆ±", "å¯¹æ–¹è½»è½»æ‹äº†æ‹ä½ "]
        };
        
        function loadPatSettings() {
            const savedSettings = localStorage.getItem('patSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                patSettings.userPatText = settings.userPatText || "ä½ æ‹äº†æ‹å¯¹æ–¹";
                patSettings.characterPatTexts = settings.characterPatTexts || ["å¯¹æ–¹æ‹äº†æ‹ä½ ", "å¯¹æ–¹è§‰å¾—ä½ å¾ˆå¯çˆ±", "å¯¹æ–¹è½»è½»æ‹äº†æ‹ä½ "];
                
                userPatTextInput.value = patSettings.userPatText;
                characterPatTextInput.value = patSettings.characterPatTexts.join('\n');
            }
        }
        
        savePatSettingsBtn.addEventListener('click', () => {
            patSettings.userPatText = userPatTextInput.value.trim() || "ä½ æ‹äº†æ‹å¯¹æ–¹";
            patSettings.characterPatTexts = characterPatTextInput.value.split('\n')
                .filter(line => line.trim() !== '')
                .map(line => line.trim());
            
            if (patSettings.characterPatTexts.length === 0) {
                patSettings.characterPatTexts = ["å¯¹æ–¹æ‹äº†æ‹ä½ "];
            }
            
            localStorage.setItem('patSettings', JSON.stringify(patSettings));
            alert('æ‹ä¸€æ‹è®¾ç½®å·²ä¿å­˜ï¼');
        });

        function handleImageUpload(file, callback) { if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => callback(e.target.result); reader.readAsDataURL(file); } }

        const photoUpload = document.getElementById('photo-upload'); 
        const photoContainer = document.getElementById('photo-container'); 
        photoUpload.addEventListener('change', function(event) { const file = event.target.files[0]; handleImageUpload(file, async (img) => { photoContainer.style.backgroundImage = `url(${img})`; photoContainer.textContent = ''; await SimpleDB.set('images', 'user_widget_photo', img); }); });

        document.getElementById('upload-desktop-wallpaper-btn').addEventListener('click', () => desktopWallpaperUpload.click());
        desktopWallpaperUpload.addEventListener('change', (e) => handleImageUpload(e.target.files[0], async (img) => { desktop.style.backgroundImage = `url(${img})`; desktopWallpaperPreview.style.backgroundImage = `url(${img})`; await SimpleDB.set('images', 'desktopWallpaper', img); }));
        document.getElementById('reset-desktop-wallpaper-btn').addEventListener('click', async () => { desktop.style.backgroundImage = ''; desktopWallpaperPreview.style.backgroundImage = ''; await SimpleDB.del('images', 'desktopWallpaper'); });

        document.getElementById('upload-chat-wallpaper-btn').addEventListener('click', () => chatWallpaperUpload.click());
        chatWallpaperUpload.addEventListener('change', (e) => handleImageUpload(e.target.files[0], async (img) => { chatBody.style.backgroundImage = `url(${img})`; chatWallpaperPreview.style.backgroundImage = `url(${img})`; await SimpleDB.set('images', 'chatWallpaper', img); }));
        document.getElementById('reset-chat-wallpaper-btn').addEventListener('click', async () => { chatBody.style.backgroundImage = ''; chatWallpaperPreview.style.backgroundImage = ''; await SimpleDB.del('images', 'chatWallpaper'); });

        async function renderAppIconSettings() { appIconSettingsContainer.innerHTML = ''; for(const app of apps) { const iconUrl = await SimpleDB.get('images', `appIcon_${app.id}`); const item = document.createElement('div'); item.className = 'app-icon-setting-item'; item.innerHTML = `<div class="icon-preview" id="preview-${app.id}" style="background-image: url(${iconUrl || ''})"></div><span>${app.name}</span><div class="appearance-controls"><button class="settings-button" data-app-id="${app.id}">ä¸Šä¼ </button></div><input type="file" id="upload-${app.id}" accept="image/*" style="display:none;">`; appIconSettingsContainer.appendChild(item); } }
        appIconSettingsContainer.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { document.getElementById(`upload-${e.target.dataset.appId}`).click(); }});
        appIconSettingsContainer.addEventListener('change', (e) => { if (e.target.tagName === 'INPUT' && e.target.type === 'file') { const appId = e.target.id.replace('upload-', ''); handleImageUpload(e.target.files[0], async (img) => { document.querySelector(`#${appId} .icon-placeholder`).style.backgroundImage = `url(${img})`; document.getElementById(`preview-${appId}`).style.backgroundImage = `url(${img})`; await SimpleDB.set('images', `appIcon_${appId}`, img); }); } });

        async function loadAppearanceSettings() { 
            const desktopWallpaper = await SimpleDB.get('images', 'desktopWallpaper'); if(desktopWallpaper) { desktop.style.backgroundImage = `url(${desktopWallpaper})`; desktopWallpaperPreview.style.backgroundImage = `url(${desktopWallpaper})`;} 
            const chatWallpaper = await SimpleDB.get('images', 'chatWallpaper'); if(chatWallpaper) { chatBody.style.backgroundImage = `url(${chatWallpaper})`; chatWallpaperPreview.style.backgroundImage = `url(${chatWallpaper})`;} 
            const userPhoto = await SimpleDB.get('images', 'user_widget_photo'); if(userPhoto) { photoContainer.style.backgroundImage = `url(${userPhoto})`; photoContainer.textContent = ''; }
            for(const app of apps) { const iconUrl = await SimpleDB.get('images', `appIcon_${app.id}`); if (iconUrl) { document.querySelector(`#${app.id} .icon-placeholder`).style.backgroundImage = `url(${iconUrl})`; } }
        }
        
        const fontUrlInput = document.getElementById('font-url'); const applyFontBtn = document.getElementById('apply-font-btn'); const resetFontBtn = document.getElementById('reset-font-btn'); const customFontStylesheet = document.createElement('style'); document.head.appendChild(customFontStylesheet);
        function applyFont(fontUrl) { if (!fontUrl) { customFontStylesheet.innerHTML = ""; document.body.style.fontFamily = ""; return; } const fontName = 'CustomFont'; const fontFaceRule = `@font-face { font-family: '${fontName}'; src: url('${fontUrl}'); }`; const bodyRule = `body, button, input, textarea, select { font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important; }`; customFontStylesheet.innerHTML = fontFaceRule + bodyRule; localStorage.setItem('customFontUrl', fontUrl); }
        applyFontBtn.addEventListener('click', () => { const url = fontUrlInput.value.trim(); if (url) { applyFont(url); alert('å­—ä½“å·²åº”ç”¨ï¼'); } else { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å­—ä½“URLã€‚'); } });
        resetFontBtn.addEventListener('click', () => { applyFont(null); fontUrlInput.value = ''; localStorage.removeItem('customFontUrl'); alert('å·²æ¢å¤é»˜è®¤å­—ä½“ã€‚'); });
        function loadFontSettings() { const savedFontUrl = localStorage.getItem('customFontUrl'); if (savedFontUrl) { fontUrlInput.value = savedFontUrl; applyFont(savedFontUrl); } }

        // --- å¤‡ä»½/å¯¼å…¥ ---
        const backupDataBtn = document.getElementById('backup-data-btn'); const importDataBtn = document.getElementById('import-data-btn'); const importDataUpload = document.getElementById('import-data-upload'); const resetAllDataBtn = document.getElementById('reset-all-data-btn');
        function recursiveParse(data) { if (typeof data === 'string') { try { const parsed = JSON.parse(data); return recursiveParse(parsed); } catch (e) { return data; } } else if (typeof data === 'object' && data !== null) { for (let key in data) { data[key] = recursiveParse(data[key]); } } return data; }
        backupDataBtn.addEventListener('click', async () => { showLoading('æ­£åœ¨æ‰“åŒ…å¤‡ä»½æ•°æ®...'); try { const localStorageData = { ...localStorage }; const imagesData = await SimpleDB.getAll('images'); const dbData = await SimpleDB.getAll('data'); const finalBackup = { version: 2, ls: localStorageData, db_images: imagesData, db_data: dbData }; const dataStr = JSON.stringify(finalBackup); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const a = document.createElement('a'); a.href = url; const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-'); a.download = `backup-full-${timestamp}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } catch(e) { alert('å¤‡ä»½å¤±è´¥ï¼š' + e); } finally { hideLoading(); } });
        importDataBtn.addEventListener('click', () => { importDataUpload.click(); });
        importDataUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰è®¾ç½®å’Œæ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) { showLoading('æ­£åœ¨æ¢å¤æ•°æ®...'); const reader = new FileReader(); reader.onload = async (event) => { try { let importedData = JSON.parse(event.target.result); importedData = recursiveParse(importedData); if(!importedData.version) { console.log("æ£€æµ‹åˆ°æ—§ç‰ˆå¤‡ä»½ï¼Œæ­£åœ¨å°è¯•å…¨é¢è¿ç§»æ•°æ®..."); localStorage.clear(); let deckDataToImport = importedData.cardDecks; if (!deckDataToImport) { deckDataToImport = importedData.cardDecksData || {}; } await SimpleDB.set('data', 'cardDecksData', deckDataToImport); if(importedData.currentActiveDeck) await SimpleDB.set('data', 'currentActiveDeck', importedData.currentActiveDeck); if(importedData.chatCharacters) await SimpleDB.set('data', 'chatCharacters', importedData.chatCharacters); if(importedData.chatHistory) await SimpleDB.set('data', 'chatHistory', importedData.chatHistory); if(importedData.noteHistory) await SimpleDB.set('data', 'noteHistory', importedData.noteHistory); if(importedData.currentChatCharacterId) await SimpleDB.set('data', 'currentChatCharacterId', importedData.currentChatCharacterId); const imageKeys = ['desktopWallpaper', 'chatWallpaper', 'user_widget_photo']; for(const key in importedData) { if(imageKeys.includes(key) || key.startsWith('appIcon_')) { await SimpleDB.set('images', key, importedData[key]); } else if (['cardDecks', 'chatCharacters', 'chatHistory', 'noteHistory', 'currentActiveDeck', 'currentChatCharacterId'].includes(key)) { } else { localStorage.setItem(key, typeof importedData[key] === 'object' ? JSON.stringify(importedData[key]) : importedData[key]); } } alert('æ—§ç‰ˆæ•°æ®ï¼ˆå«å¤–è§‚ã€ç‰Œç»„ã€å†å²ï¼‰å·²æˆåŠŸè¿ç§»å¹¶å¯¼å…¥ï¼é¡µé¢å°†åˆ·æ–°ã€‚'); } else { localStorage.clear(); if(importedData.ls) Object.keys(importedData.ls).forEach(key => localStorage.setItem(key, importedData.ls[key])); if(importedData.db_images) { for(const k in importedData.db_images) await SimpleDB.set('images', k, importedData.db_images[k]); } if(importedData.db_data) { for(const k in importedData.db_data) await SimpleDB.set('data', k, importedData.db_data[k]); } alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚'); } location.reload(); } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å·²æŸåã€‚'); console.error("å¯¼å…¥é”™è¯¯:", err); } finally { hideLoading(); } }; reader.readAsText(file); } e.target.value = ''; });
        resetAllDataBtn.addEventListener('click', async () => { if (confirm('ã€é«˜å±æ“ä½œã€‘è¿™å°†æ¸…ç©ºæ‰€æœ‰è§’è‰²ã€å¡ç»„ã€èŠå¤©è®°å½•å’Œè®¾ç½®ï¼æ­¤æ“ä½œä¸å¯é€†ï¼Œç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) { localStorage.clear(); indexedDB.deleteDatabase(SimpleDB.dbName); alert('æ‰€æœ‰æ•°æ®å·²é‡ç½®ã€‚é¡µé¢å°†åˆ·æ–°ã€‚'); location.reload(); } });

        // --- æŠ½å¡ ---
        const timeDisplay = document.getElementById('time-display'); const dateDisplay = document.getElementById('date-display'); const weekDays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­']; 
        function updateTime() { const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); timeDisplay.textContent = `${hours}:${minutes}`; const month = now.getMonth() + 1; const day = now.getDate(); const weekDay = weekDays[now.getDay()]; dateDisplay.textContent = `${month}æœˆ${day}æ—¥, ${weekDay}`; } updateTime(); setInterval(updateTime, 60000);
        const deckSettingsModal = document.getElementById('deck-settings-modal'); const openModalBtn = document.getElementById('nav-deck-settings'); const closeModalBtn = document.getElementById('close-modal-btn'); const saveDeckBtn = document.getElementById('save-deck-btn'); const deckSelector = document.getElementById('deck-selector'); const currentDeckNameInput = document.getElementById('current-deck-name'); const cardListContainer = document.getElementById('card-list-container'); const newCardInput = document.getElementById('new-card-input'); const addCardBtn = document.getElementById('add-card-btn'); const searchCardInput = document.getElementById('search-card-input'); const bulkImportModal = document.getElementById('bulk-import-modal'); const bulkImportBtn = document.getElementById('bulk-import-btn'); const confirmBulkImportBtn = document.getElementById('confirm-bulk-import-btn'); const cancelBulkImportBtn = document.getElementById('cancel-bulk-import-btn'); const bulkImportTextarea = document.getElementById('bulk-import-textarea'); const cardStack = document.getElementById('card-stack'); const questionInput = document.getElementById('question-input'); const askButton = document.getElementById('ask-button'); const drawCountIndicator = document.getElementById('draw-count-indicator'); const cardCharSelector = document.getElementById('card-char-selector');
        
        // æŠ½å¡æ§åˆ¶å…ƒç´ 
        const minDrawCountInput = document.getElementById('min-draw-count');
        const maxDrawCountInput = document.getElementById('max-draw-count');
        const randomModeControl = document.getElementById('random-mode-control');
        
        let cardDecks = {}; let originalDeckNameToEdit = ""; let currentActiveDeckName = ""; let isShuffling = false;
        async function loadDecks() { const savedDecks = await SimpleDB.get('data', 'cardDecksData'); cardDecks = savedDecks || {}; currentActiveDeckName = await SimpleDB.get('data', 'currentActiveDeck') || Object.keys(cardDecks)[0] || ""; updateDeckSelectorAndLoadForEditing(); } 
        async function saveDecksToDB() { await SimpleDB.set('data', 'cardDecksData', cardDecks); await SimpleDB.set('data', 'currentActiveDeck', currentActiveDeckName); }
        function updateDeckSelectorAndLoadForEditing() { const selectedDeckForEditing = deckSelector.value; deckSelector.innerHTML = ''; Object.keys(cardDecks).forEach(name => { const option = new Option(name, name); deckSelector.add(option); }); const createNewOption = new Option("--- åˆ›å»ºæ–°ç‰Œç»„ ---", "__CREATE_NEW__"); deckSelector.add(createNewOption); const deckToLoad = cardDecks[selectedDeckForEditing] ? selectedDeckForEditing : currentActiveDeckName; deckSelector.value = deckToLoad || "__CREATE_NEW__"; loadDeckIntoEditor(deckToLoad); } 
        function loadDeckIntoEditor(deckName) { originalDeckNameToEdit = deckName; currentDeckNameInput.value = deckName; const cards = cardDecks[deckName] || []; renderCardList(cards); searchCardInput.value = ''; } 
        function clearEditorForNewDeck() { originalDeckNameToEdit = ""; currentDeckNameInput.value = ""; currentDeckNameInput.placeholder = "ä¸ºæ–°ç‰Œç»„å‘½å"; cardListContainer.innerHTML = ""; searchCardInput.value = ""; deckSelector.value = "__CREATE_NEW__"; } 
        function renderCardList(cards) { cardListContainer.innerHTML = ''; cards.forEach(cardText => { const cardItem = document.createElement('div'); cardItem.className = 'card-item'; cardItem.innerHTML = `<span>${cardText}</span><button class="delete-card-btn">&times;</button>`; cardListContainer.appendChild(cardItem); }); }
        searchCardInput.addEventListener('input', () => { const searchTerm = searchCardInput.value.toLowerCase(); Array.from(cardListContainer.children).forEach(item => { const cardText = item.querySelector('span').textContent.toLowerCase(); item.style.display = cardText.includes(searchTerm) ? 'flex' : 'none'; }); }); 
        cardListContainer.addEventListener('click', e => { if (e.target.classList.contains('delete-card-btn')) { e.target.parentElement.remove(); } }); 
        deckSelector.addEventListener('change', () => { const selectedValue = deckSelector.value; if (selectedValue === "__CREATE_NEW__") { clearEditorForNewDeck(); } else { loadDeckIntoEditor(selectedValue); currentActiveDeckName = selectedValue; saveDecksToDB(); } }); 
        addNewCardToUI = () => { const text = newCardInput.value.trim(); if(text){ const item = document.createElement('div'); item.className = 'card-item'; item.innerHTML = `<span>${text}</span><button class="delete-card-btn">&times;</button>`; cardListContainer.appendChild(item); newCardInput.value = ''; newCardInput.focus(); } }; 
        addCardBtn.addEventListener('click', addNewCardToUI); newCardInput.addEventListener('keypress', e => { if (e.key === 'Enter') addNewCardToUI(); }); 
        saveDeckBtn.addEventListener('click', async () => { const newDeckName = currentDeckNameInput.value.trim(); if (!newDeckName) { alert("ç‰Œç»„åç§°ä¸èƒ½ä¸ºç©ºï¼"); return; } const newCards = Array.from(cardListContainer.querySelectorAll('.card-item span')).map(span => span.textContent); if (originalDeckNameToEdit && originalDeckNameToEdit !== newDeckName) { delete cardDecks[originalDeckNameToEdit]; } cardDecks[newDeckName] = newCards; currentActiveDeckName = newDeckName; await saveDecksToDB(); alert(`ç‰Œç»„ "${newDeckName}" å·²ä¿å­˜æˆåŠŸï¼`); updateDeckSelectorAndLoadForEditing(); clearEditorForNewDeck(); });
        openModalBtn.addEventListener('click', () => { deckSettingsModal.style.display = 'flex'; document.getElementById('card-back-btn').style.visibility = 'hidden'; loadDecks(); }); 
        closeModalBtn.addEventListener('click', () => { deckSettingsModal.style.display = 'none'; document.getElementById('card-back-btn').style.visibility = 'visible'; }); 
        bulkImportBtn.addEventListener('click', () => { bulkImportModal.style.display = 'flex'; bulkImportTextarea.value = ''; bulkImportTextarea.focus(); }); cancelBulkImportBtn.addEventListener('click', () => { bulkImportModal.style.display = 'none'; }); 
        confirmBulkImportBtn.addEventListener('click', () => { const text = bulkImportTextarea.value.trim(); if (text) { const cards = text.split('\n').filter(line => line.trim() !== ''); cards.forEach(cardText => { const item = document.createElement('div'); item.className = 'card-item'; item.innerHTML = `<span>${cardText.trim()}</span><button class="delete-card-btn">&times;</button>`; cardListContainer.appendChild(item); }); } bulkImportModal.style.display = 'none'; });
        
        // ç¡®ä¿éšæœºæ¨¡å¼æ§åˆ¶å§‹ç»ˆæ˜¾ç¤º
        randomModeControl.style.display = 'flex';
        
        // --- è§’è‰²å’ŒèŠå¤© ---
        const charManagerModal = document.getElementById('character-manager-modal'); const charEditorModal = document.getElementById('character-editor-modal'); const closeCharManagerBtn = document.getElementById('close-char-manager-modal-btn'); const closeCharEditorBtn = document.getElementById('close-char-editor-modal-btn'); const saveCharBtn = document.getElementById('save-char-btn'); const charListContainer = document.getElementById('character-list'); const chatHeaderTitle = document.getElementById('chat-header-title'); const chatActionsBtn = document.getElementById('chat-actions-btn'); const chatActionsMenu = document.getElementById('chat-actions-menu');
        const chatHeaderNormal = document.getElementById('chat-header-normal');
        const chatSelectionHeader = document.getElementById('chat-selection-header');
        const selectionCancelBtn = document.getElementById('selection-cancel-btn');
        const selectionDeleteBtn = document.getElementById('selection-delete-btn');
        const selectionTitle = document.getElementById('selection-title');

        // èŠå¤©è¾“å…¥ç›¸å…³å…ƒç´ 
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatMultiMessageBtn = document.getElementById('chat-multi-message-btn');
        const chatQuoteBtn = document.getElementById('chat-quote-btn');
        const chatPatBtn = document.getElementById('chat-pat-btn');
        
        // èŠå¤©è§’è‰²é€‰æ‹©å™¨
        const chatCharacterSelector = document.getElementById('chat-character-selector');

        // å¤šæ¡æ¶ˆæ¯çª—å£ç›¸å…³å…ƒç´ 
        const multiMessageWindow = document.getElementById('multi-message-window');
        const multiMessageClose = document.getElementById('multi-message-close');
        const multiMessageContent = document.getElementById('multi-message-content');
        const multiMessageInput = document.getElementById('multi-message-input');
        const multiMessageAddBtn = document.getElementById('multi-message-add-btn');
        const multiMessageSendBtn = document.getElementById('multi-message-send-btn');

        let characters = {}; let currentChatCharacterId = null; let chatHistory = {}; 
        
        // é€‰æ‹©æ¨¡å¼çŠ¶æ€
        let isChatSelectionMode = false;
        let selectedMessageIndices = new Set(); // å­˜å‚¨é€‰ä¸­çš„æ¶ˆæ¯ç´¢å¼•
        
        // å¼•ç”¨å›å¤ç›¸å…³çŠ¶æ€
        let quotedMessageIndex = null; // å½“å‰å¼•ç”¨çš„æ¶ˆæ¯ç´¢å¼•

        // å¤šæ¡æ¶ˆæ¯çŠ¶æ€
        let multiMessages = []; // å­˜å‚¨å¤šæ¡æ¶ˆæ¯çš„æ•°ç»„

        // è§’è‰²å¼•ç”¨çŠ¶æ€
        let characterQuotedMessageIndex = null; // è§’è‰²å¼•ç”¨çš„æ¶ˆæ¯ç´¢å¼•

        // æ–°å¢æœç´¢ç›¸å…³å˜é‡
        let searchResults = [];
        let currentSearchIndex = -1;
        let isSearchMode = false;

        async function loadChatData() { 
            characters = await SimpleDB.get('data', 'chatCharacters') || {}; 
            chatHistory = await SimpleDB.get('data', 'chatHistory') || {}; 
            currentChatCharacterId = await SimpleDB.get('data', 'currentChatCharacterId'); 
            renderChatCharacterSelector(); 
            if(currentChatCharacterId) switchToCharacter(currentChatCharacterId); 
            updateCardAppCharSelector();
        } 
        async function saveChatData() { 
            await SimpleDB.set('data', 'chatCharacters', characters); 
            await SimpleDB.set('data', 'chatHistory', chatHistory); 
        }

        function renderCharacterListInManager() { charListContainer.innerHTML = ''; for (const id in characters) { const item = document.createElement('div'); item.className = 'character-item'; item.dataset.id = id; item.innerHTML = `<span>${characters[id].name}</span><span class="delete-char-btn" data-id="${id}">&times;</span>`; charListContainer.appendChild(item); } } 
        
        // æ¸²æŸ“èŠå¤©è§’è‰²é€‰æ‹©å™¨
        function renderChatCharacterSelector() {
            chatCharacterSelector.innerHTML = '';
            const charKeys = Object.keys(characters);
            if (charKeys.length === 0) {
                const option = new Option("è¯·å…ˆæ·»åŠ è§’è‰²", "");
                chatCharacterSelector.add(option);
                chatCharacterSelector.disabled = true;
            } else {
                chatCharacterSelector.disabled = false;
                const defaultOption = new Option("--- è¯·é€‰æ‹©è§’è‰² ---", "");
                chatCharacterSelector.add(defaultOption);
                charKeys.forEach(id => {
                    const option = new Option(characters[id].name, id);
                    chatCharacterSelector.add(option);
                });
                if (currentChatCharacterId) {
                    chatCharacterSelector.value = currentChatCharacterId;
                }
            }
        }
        
        function updateCardAppCharSelector() {
            cardCharSelector.innerHTML = '';
            const charKeys = Object.keys(characters);
            if (charKeys.length === 0) {
                const option = new Option("è¯·å…ˆåœ¨é€šè®¯å½•æ·»åŠ è§’è‰²", "");
                cardCharSelector.add(option);
                cardCharSelector.disabled = true;
            } else {
                cardCharSelector.disabled = false;
                const defaultOption = new Option("--- è¯·é€‰æ‹©è§’è‰² ---", "");
                cardCharSelector.add(defaultOption);
                charKeys.forEach(id => {
                    const option = new Option(characters[id].name, id);
                    cardCharSelector.add(option);
                });
                if (currentChatCharacterId) {
                    cardCharSelector.value = currentChatCharacterId;
                }
            }
        }
        
        // èŠå¤©è§’è‰²é€‰æ‹©å™¨äº‹ä»¶
        chatCharacterSelector.addEventListener('change', (e) => {
            const newId = e.target.value;
            if (newId) {
                switchToCharacter(newId);
            } else {
                currentChatCharacterId = null;
                checkGameState();
            }
        });
        
        cardCharSelector.addEventListener('change', (e) => {
            const newId = e.target.value;
            if (newId) {
                switchToCharacter(newId);
            } else {
                currentChatCharacterId = null;
                checkGameState();
            }
        });

        // æ·»åŠ æ¶ˆæ¯æ—¶æ”¯æŒæ—¶é—´æˆ³å‚æ•°
        function addMessageToChat(characterId, sender, text, cardColorIndex = null, timestamp = null, quoteIndex = null, isPat = false) { 
            if (!chatHistory[characterId]) chatHistory[characterId] = []; 
            
            // å¦‚æœæ²¡æœ‰æä¾›æ—¶é—´æˆ³ï¼Œç”Ÿæˆå½“å‰æ—¶é—´
            if (!timestamp) {
                const now = new Date();
                timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            }
            
            const message = { sender, text, timestamp, isPat };
            if (quoteIndex !== null) {
                message.quoteIndex = quoteIndex;
            }
            chatHistory[characterId].push(message); 
            saveChatData(); 
            if (characterId === currentChatCharacterId) {
                renderChatBody(characterId);
            }
        }        
        
        // renderChatBody å‡½æ•°ï¼Œæ·»åŠ æ—¶é—´æˆ³æ˜¾ç¤ºå’Œå¼•ç”¨æ¶ˆæ¯ä¼˜åŒ–
        function renderChatBody(characterId, showAll = false) { 
            chatBody.innerHTML = ''; 
            const fullHistory = chatHistory[characterId] || []; 
            
            if (fullHistory.length === 0) { 
                chatBody.innerHTML = '<p style="text-align: center; color: #aaa;">å¼€å§‹å¯¹è¯å§</p>'; 
                return; 
            } 

            let startIndex = 0;
            let displayHistory = fullHistory;
            if (!showAll && fullHistory.length > 30) {
                startIndex = fullHistory.length - 30;
                displayHistory = fullHistory.slice(-30);
                const loadBtn = document.createElement('div');
                loadBtn.className = 'chat-load-more-btn';
                loadBtn.textContent = `åŠ è½½å…¨éƒ¨å†å²è®°å½• (${fullHistory.length - 30}æ¡æ›´å¤š)`;
                loadBtn.onclick = () => renderChatBody(characterId, true); 
                chatBody.appendChild(loadBtn);
            }

            const char = characters[characterId]; 
            
            let lastDate = null;
            
            displayHistory.forEach((msg, i) => { 
                const absoluteIndex = startIndex + i;
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ—¥æœŸåˆ†éš”
                const messageDate = new Date(msg.timestamp).toDateString();
                if (messageDate !== lastDate) {
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'message-timestamp';
                    dateSeparator.innerHTML = `<span>${formatDate(new Date(msg.timestamp))}</span>`;
                    chatBody.appendChild(dateSeparator);
                    lastDate = messageDate;
                }
                
                // å¦‚æœæ˜¯æ‹ä¸€æ‹æ¶ˆæ¯ï¼Œç‰¹æ®Šå¤„ç†
                if (msg.isPat) {
                    const patMessageEl = document.createElement('div');
                    patMessageEl.className = 'pat-message';
                    patMessageEl.textContent = msg.text;
                    chatBody.appendChild(patMessageEl);
                    return;
                }
                
                const messageEl = document.createElement('div'); 
                messageEl.className = `chat-message ${msg.sender}`; 
                messageEl.dataset.index = absoluteIndex;

                if (selectedMessageIndices.has(absoluteIndex)) {
                    messageEl.classList.add('selected');
                }

                let bubbleHTML = '';
                
                if (msg.sender === 'character') { 
                    bubbleHTML += `<div class="avatar" style="background-image: url(${char.avatar || ''})"></div><div class="bubble" data-timestamp="${msg.timestamp}">${msg.text}`; 
                } else { 
                    bubbleHTML += `<div class="bubble" data-timestamp="${msg.timestamp}">${msg.text}`; 
                } 
                
                // å¦‚æœæœ‰å¼•ç”¨ï¼Œæ·»åŠ å¼•ç”¨å†…å®¹ï¼ˆåœ¨æ¶ˆæ¯å†…å®¹ä¸‹æ–¹ï¼‰
                if (msg.quoteIndex !== undefined && msg.quoteIndex !== null) {
                    const quotedMsg = fullHistory[msg.quoteIndex];
                    if (quotedMsg) {
                        bubbleHTML += `<div class="quote"><span class="quote-text">${quotedMsg.text}</span></div>`;
                    }
                }
                
                bubbleHTML += `</div>`;
                messageEl.innerHTML = bubbleHTML; 

                // äº‹ä»¶ç»‘å®š
                let pressTimer;

                // è§¦æ‘¸äº‹ä»¶
                messageEl.addEventListener('touchstart', (e) => {
                    if(isChatSelectionMode) return;
                    pressTimer = setTimeout(() => {
                        enterSelectionMode(absoluteIndex);
                    }, 800);
                });
                messageEl.addEventListener('touchend', () => clearTimeout(pressTimer));
                messageEl.addEventListener('touchmove', () => clearTimeout(pressTimer));

                // é¼ æ ‡äº‹ä»¶
                messageEl.addEventListener('mousedown', (e) => {
                    if(isChatSelectionMode) return;
                    pressTimer = setTimeout(() => {
                        enterSelectionMode(absoluteIndex);
                    }, 800);
                });
                messageEl.addEventListener('mouseup', () => clearTimeout(pressTimer));
                messageEl.addEventListener('mouseleave', () => clearTimeout(pressTimer));

                // ç‚¹å‡»äº‹ä»¶
                messageEl.addEventListener('click', (e) => {
                    if (isChatSelectionMode) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleMessageSelection(absoluteIndex);
                    } else {
                        // å¦‚æœä¸æ˜¯é€‰æ‹©æ¨¡å¼ï¼Œé•¿æŒ‰æˆ–ç‚¹å‡»å¯ä»¥è®¾ç½®è§’è‰²å¼•ç”¨
                        if (msg.sender === 'user') {
                            characterQuotedMessageIndex = absoluteIndex;
                            updateQuoteButtonState();
                            
                            // åœ¨è¾“å…¥æ¡†ä¸­æ˜¾ç¤ºå¼•ç”¨æç¤º
                            const quoteText = msg.text.length > 30 ? msg.text.substring(0, 30) + '...' : msg.text;
                            chatInput.placeholder = `è§’è‰²å°†å¼•ç”¨: ${quoteText}`;
                            
                            // çŸ­æš‚é«˜äº®æ˜¾ç¤ºè¢«å¼•ç”¨çš„æ¶ˆæ¯
                            messageEl.style.backgroundColor = 'rgba(66, 133, 244, 0.1)';
                            setTimeout(() => {
                                messageEl.style.backgroundColor = '';
                            }, 2000);
                        }
                    }
                });

                chatBody.appendChild(messageEl); 
            }); 
            
            if (selectedMessageIndices.size === 0) {
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸå‡½æ•°
        function formatDate(date) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'ä»Šå¤©';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'æ˜¨å¤©';
            } else {
                return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
            }
        }

        // é€‰æ‹©æ¨¡å¼é€»è¾‘
        function enterSelectionMode(initialIndex) {
            if (isChatSelectionMode) return;
            isChatSelectionMode = true;
            selectedMessageIndices.clear();
            if (initialIndex !== null && initialIndex !== undefined) {
                selectedMessageIndices.add(initialIndex);
            }
            
            // UI åˆ‡æ¢
            chatHeaderNormal.style.display = 'none';
            chatSelectionHeader.style.display = 'flex';
            updateSelectionUI();
            
            // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºé€‰ä¸­æ ·å¼
            renderChatBody(currentChatCharacterId, false);
        }

        function exitSelectionMode() {
            isChatSelectionMode = false;
            selectedMessageIndices.clear();
            
            chatHeaderNormal.style.display = 'flex';
            chatSelectionHeader.style.display = 'none';
            
            renderChatBody(currentChatCharacterId, false);
        }

        function toggleMessageSelection(index) {
            if (selectedMessageIndices.has(index)) {
                selectedMessageIndices.delete(index);
            } else {
                selectedMessageIndices.add(index);
            }
            updateSelectionUI();
            
            // åªæ›´æ–° DOM classï¼Œé¿å…å®Œå…¨é‡ç»˜å¯¼è‡´é—ªçƒ
            const msgEl = chatBody.querySelector(`.chat-message[data-index="${index}"]`);
            if (msgEl) {
                if (selectedMessageIndices.has(index)) msgEl.classList.add('selected');
                else msgEl.classList.remove('selected');
            }
        }

        function updateSelectionUI() {
            const count = selectedMessageIndices.size;
            selectionTitle.textContent = count > 0 ? `å·²é€‰æ‹© ${count} æ¡` : 'è¯·é€‰æ‹©æ¶ˆæ¯';
            selectionDeleteBtn.style.opacity = count > 0 ? '1' : '0.5';
        }

        // åˆ é™¤é€‰ä¸­æ¶ˆæ¯
        selectionDeleteBtn.addEventListener('click', async () => {
            if (selectedMessageIndices.size === 0) return;
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤è¿™ ${selectedMessageIndices.size} æ¡æ¶ˆæ¯å—ï¼Ÿ`)) {
                const history = chatHistory[currentChatCharacterId];
                // ä»åå¾€å‰åˆ ï¼Œé¿å…ç´¢å¼•é”™ä½
                const indicesData = Array.from(selectedMessageIndices).sort((a, b) => b - a);
                
                indicesData.forEach(index => {
                    if (index >= 0 && index < history.length) {
                        history.splice(index, 1);
                    }
                });
                
                await saveChatData();
                exitSelectionMode();
            }
        });

        selectionCancelBtn.addEventListener('click', exitSelectionMode);

        async function switchToCharacter(id) { 
            // åˆ‡æ¢è§’è‰²æ—¶å¼ºåˆ¶é€€å‡ºé€‰æ‹©æ¨¡å¼
            if(isChatSelectionMode) exitSelectionMode();

            if (!id || !characters[id]) { 
                chatHeaderTitle.textContent = "é€šè®¯"; 
                chatBody.innerHTML = '<p style="text-align: center; color: #aaa;">è¯·å…ˆæ·»åŠ å¹¶é€‰æ‹©ä¸€ä¸ªè§’è‰²</p>'; 
                currentChatCharacterId = null; 
                await SimpleDB.del('data', 'currentChatCharacterId'); 
                renderChatCharacterSelector(); 
                checkGameState(); 
                return; 
            } 
            currentChatCharacterId = id; 
            await SimpleDB.set('data', 'currentChatCharacterId', id); 
            const char = characters[id]; 
            chatHeaderTitle.textContent = char.name; 
            renderChatBody(id, false); 
            renderChatCharacterSelector(); 
            if (cardCharSelector.value !== id) {
                cardCharSelector.value = id;
            }
            if (chatCharacterSelector.value !== id) {
                chatCharacterSelector.value = id;
            }
            checkGameState(); 
        }
        
        chatActionsBtn.addEventListener('click', (e) => { e.stopPropagation(); chatActionsMenu.style.display = chatActionsMenu.style.display === 'flex' ? 'none' : 'flex'; }); 
        document.addEventListener('click', () => chatActionsMenu.style.display = 'none');
        
        document.getElementById('add-character-menu-btn').addEventListener('click', () => { document.getElementById('char-editor-title').textContent = 'åˆ›å»ºæ–°è§’è‰²'; document.getElementById('editing-char-id').value = ''; document.getElementById('edit-char-name').value = ''; document.getElementById('edit-char-prompt').value = ''; const avatarPreview = document.getElementById('edit-char-avatar-preview'); avatarPreview.style.backgroundImage = ''; avatarPreview.textContent = 'ç‚¹å‡»ä¸Šä¼ '; charEditorModal.style.display = 'flex'; });
        document.getElementById('manage-characters-menu-btn').addEventListener('click', () => { renderCharacterListInManager(); charManagerModal.style.display = 'flex'; });
        document.getElementById('pat-settings-menu-btn').addEventListener('click', () => { openSettingsSubView(appearanceSettingsView); });
        closeCharManagerBtn.addEventListener('click', () => charManagerModal.style.display = 'none');
        
        charListContainer.addEventListener('click', async (e) => { e.stopPropagation(); if (e.target.classList.contains('delete-char-btn')) { const charId = e.target.dataset.id; if (confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰² "${characters[charId].name}" å—ï¼Ÿ`)) { delete characters[charId]; if(currentChatCharacterId === charId) await switchToCharacter(null); saveChatData(); renderCharacterListInManager(); renderChatCharacterSelector(); updateCardAppCharSelector(); } } else { const target = e.target.closest('.character-item'); if (target) { const charId = target.dataset.id; const char = characters[charId]; document.getElementById('char-editor-title').textContent = 'ç¼–è¾‘è§’è‰²'; document.getElementById('editing-char-id').value = charId; document.getElementById('edit-char-name').value = char.name; document.getElementById('edit-char-prompt').value = char.prompt || ''; const avatarPreview = document.getElementById('edit-char-avatar-preview'); avatarPreview.style.backgroundImage = `url(${char.avatar || ''})`; avatarPreview.textContent = char.avatar ? '' : 'ç‚¹å‡»ä¸Šä¼ '; charManagerModal.style.display = 'none'; charEditorModal.style.display = 'flex'; } } });
        closeCharEditorBtn.addEventListener('click', () => charEditorModal.style.display = 'none');
        
        saveCharBtn.addEventListener('click', () => { let id = document.getElementById('editing-char-id').value; const name = document.getElementById('edit-char-name').value.trim(); if (!name) { alert("è§’è‰²åå­—ä¸èƒ½ä¸ºç©ºï¼"); return; } if (!id) { id = `char_${Date.now()}`; } const prompt = document.getElementById('edit-char-prompt').value.trim(); const bgImage = document.getElementById('edit-char-avatar-preview').style.backgroundImage; const avatar = bgImage.startsWith('url') ? bgImage.slice(5, -2) : ''; characters[id] = { ...characters[id], id, name, prompt, avatar }; saveChatData(); renderChatCharacterSelector(); switchToCharacter(id); updateCardAppCharSelector(); charEditorModal.style.display = 'none'; });
        document.getElementById('edit-char-avatar-upload').addEventListener('change', e => { const file = e.target.files[0]; if(file){ handleImageUpload(file, (img) => { const avatarPreview = document.getElementById('edit-char-avatar-preview'); avatarPreview.style.backgroundImage = `url(${img})`; avatarPreview.textContent = ''; }); } });
        
        // --- æ–°å¢èŠå¤©åŠŸèƒ½ ---
        
        // 1. æ¸…ç©ºèŠå¤©è®°å½•åŠŸèƒ½
        function clearChatHistory() {
            if (!currentChatCharacterId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºä¸' + characters[currentChatCharacterId].name + 'çš„èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                chatHistory[currentChatCharacterId] = [];
                saveChatData();
                renderChatBody(currentChatCharacterId, false);
                alert('èŠå¤©è®°å½•å·²æ¸…ç©º');
            }
        }

        // 2. å¼€å¯æ–°å¯¹è¯åŠŸèƒ½
        function startNewConversation() {
            if (!currentChatCharacterId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }
            
            if (confirm('ç¡®å®šè¦å¼€å¯æ–°å¯¹è¯å—ï¼Ÿå½“å‰å¯¹è¯è®°å½•å°†è¢«ä¿ç•™ï¼Œä½†ä¼šé‡ç½®å¯¹è¯çŠ¶æ€')) {
                // é‡ç½®å„ç§çŠ¶æ€
                quotedMessageIndex = null;
                characterQuotedMessageIndex = null;
                multiMessages = [];
                updateQuoteButtonState();
                chatInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
                
                // å¦‚æœæœ‰æœç´¢çŠ¶æ€ï¼Œé€€å‡ºæœç´¢æ¨¡å¼
                if (isSearchMode) {
                    exitSearchMode();
                }
                
                // å¦‚æœæœ‰é€‰æ‹©æ¨¡å¼ï¼Œé€€å‡ºé€‰æ‹©æ¨¡å¼
                if (isChatSelectionMode) {
                    exitSelectionMode();
                }
                
                alert('å·²å¼€å¯æ–°å¯¹è¯');
            }
        }

        // 3. æœç´¢èŠå¤©è®°å½•åŠŸèƒ½
        function showSearchBar() {
            if (!currentChatCharacterId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }
            
            document.getElementById('chat-search-container').style.display = 'flex';
            document.getElementById('chat-search-input').focus();
            isSearchMode = true;
        }

        function hideSearchBar() {
            document.getElementById('chat-search-container').style.display = 'none';
            document.getElementById('search-results-info').style.display = 'none';
            document.getElementById('search-navigation').style.display = 'none';
            document.getElementById('chat-search-input').value = '';
            exitSearchMode();
        }

        function performSearch() {
            const searchTerm = document.getElementById('chat-search-input').value.trim();
            if (!searchTerm) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            if (!currentChatCharacterId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }
            
            const history = chatHistory[currentChatCharacterId] || [];
            searchResults = [];
            
            history.forEach((message, index) => {
                if (message.text && message.text.toLowerCase().includes(searchTerm.toLowerCase())) {
                    searchResults.push(index);
                }
            });
            
            if (searchResults.length === 0) {
                document.getElementById('search-results-info').textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„èŠå¤©è®°å½•';
                document.getElementById('search-results-info').style.display = 'block';
                document.getElementById('search-navigation').style.display = 'none';
                currentSearchIndex = -1;
            } else {
                document.getElementById('search-results-info').textContent = 
                    `æ‰¾åˆ° ${searchResults.length} æ¡åŒ¹é…è®°å½•`;
                document.getElementById('search-results-info').style.display = 'block';
                document.getElementById('search-navigation').style.display = 'flex';
                currentSearchIndex = 0;
                highlightSearchResults(searchTerm);
                navigateToSearchResult(currentSearchIndex);
            }
        }

        function highlightSearchResults(searchTerm) {
            const history = chatHistory[currentChatCharacterId] || [];
            renderChatBody(currentChatCharacterId, true);
            
            // é«˜äº®åŒ¹é…çš„æ–‡æœ¬
            const messages = document.querySelectorAll('.chat-message');
            messages.forEach(message => {
                const index = parseInt(message.dataset.index);
                if (searchResults.includes(index)) {
                    message.classList.add('search-highlight');
                    
                    // é«˜äº®åŒ¹é…çš„æ–‡æœ¬
                    const bubble = message.querySelector('.bubble');
                    if (bubble) {
                        const text = bubble.innerHTML;
                        const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
                        bubble.innerHTML = text.replace(regex, '<mark>$1</mark>');
                    }
                }
            });
        }

        function navigateToSearchResult(index) {
            if (searchResults.length === 0 || index < 0 || index >= searchResults.length) return;
            
            currentSearchIndex = index;
            const messageIndex = searchResults[index];
            const messageElement = document.querySelector(`.chat-message[data-index="${messageIndex}"]`);
            
            if (messageElement) {
                messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // æ·»åŠ å½“å‰é«˜äº®
                document.querySelectorAll('.chat-message').forEach(msg => {
                    msg.classList.remove('search-current');
                });
                messageElement.classList.add('search-current');
                
                document.getElementById('search-results-info').textContent = 
                    `æ‰¾åˆ° ${searchResults.length} æ¡åŒ¹é…è®°å½• (${index + 1}/${searchResults.length})`;
            }
        }

        function navigateToPrevResult() {
            if (currentSearchIndex > 0) {
                navigateToSearchResult(currentSearchIndex - 1);
            }
        }

        function navigateToNextResult() {
            if (currentSearchIndex < searchResults.length - 1) {
                navigateToSearchResult(currentSearchIndex + 1);
            }
        }

        function exitSearchMode() {
            isSearchMode = false;
            searchResults = [];
            currentSearchIndex = -1;
            renderChatBody(currentChatCharacterId, false);
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // ä¿®æ”¹å‘é€æ¶ˆæ¯å‡½æ•°ï¼Œå…è®¸ç©ºæ¶ˆæ¯è§¦å‘æŠ½å¡
        function sendMessageAndDraw() {
            const messageText = chatInput.value.trim();
            
            // å³ä½¿æ¶ˆæ¯ä¸ºç©ºä¹Ÿå…è®¸å‘é€ï¼ˆè§¦å‘æŠ½å¡ï¼‰
            if (currentChatCharacterId) {
                // ç”Ÿæˆæ—¶é—´æˆ³
                const now = new Date();
                const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                // åªæœ‰å½“æ¶ˆæ¯ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                if (messageText) {
                    addMessageToChat(currentChatCharacterId, 'user', messageText, null, timestamp, quotedMessageIndex);
                }
                
                // æ¸…ç©ºè¾“å…¥æ¡†å’Œå¼•ç”¨çŠ¶æ€
                chatInput.value = '';
                quotedMessageIndex = null;
                updateQuoteButtonState();
                
                // æ‰§è¡ŒæŠ½å¡é€»è¾‘
                performChatDraw();
            }
        }

        // æ–°å¢èœå•é¡¹äº‹ä»¶ç›‘å¬
        document.getElementById('clear-chat-history-btn').addEventListener('click', clearChatHistory);
        document.getElementById('start-new-conversation-btn').addEventListener('click', startNewConversation);
        document.getElementById('search-chat-history-btn').addEventListener('click', showSearchBar);

        // æœç´¢ç›¸å…³äº‹ä»¶ç›‘å¬
        document.getElementById('chat-search-close').addEventListener('click', hideSearchBar);
        document.getElementById('chat-search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        document.getElementById('search-prev-btn').addEventListener('click', navigateToPrevResult);
        document.getElementById('search-next-btn').addEventListener('click', navigateToNextResult);
        document.getElementById('search-exit-btn').addEventListener('click', exitSearchMode);

        // --- æ¸¸æˆçŠ¶æ€ ---
        let gameState = 'can_ask'; let drawCount = 0;
        let maxDrawCount = 4; // é»˜è®¤æŠ½å¡æ¬¡æ•°
        
        const shuffleButton = document.getElementById('shuffle-button');
        
        function checkGameState() { 
            if (gameState === 'can_ask') { 
                questionInput.disabled = false; 
                askButton.disabled = !(questionInput.value.trim() !== '' && currentChatCharacterId !== null); 
                shuffleButton.disabled = true; 
                drawCountIndicator.style.visibility = 'hidden'; 
            } else { 
                questionInput.disabled = true; 
                askButton.disabled = true; 
                shuffleButton.disabled = false; 
                drawCountIndicator.style.visibility = 'visible'; 
                drawCountIndicator.textContent = `å‰©ä½™æŠ½å¡æ¬¡æ•°ï¼š${maxDrawCount - drawCount}`; 
            } 
        }
        
        questionInput.addEventListener('input', checkGameState);
        askButton.addEventListener('click', () => { 
            const questionText = questionInput.value.trim(); 
            if (questionText && currentChatCharacterId) { 
                // ç”Ÿæˆæ—¶é—´æˆ³
                const now = new Date();
                const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                addMessageToChat(currentChatCharacterId, 'user', questionText, null, timestamp);
                questionInput.value = ''; 
                gameState = 'awaiting_draws'; 
                drawCount = 0; 
                
                // æ ¹æ®éšæœºæ¨¡å¼ç¡®å®šæŠ½å¡æ¬¡æ•°
                const min = parseInt(minDrawCountInput.value);
                const max = parseInt(maxDrawCountInput.value);
                if (min >= 1 && max >= min && max <= 20) {
                    maxDrawCount = Math.floor(Math.random() * (max - min + 1)) + min;
                } else {
                    maxDrawCount = 4; // é»˜è®¤å€¼
                }
                
                checkGameState(); 
                cardStack.querySelector('.pos-top .card-content').textContent = 'è¯·æŠ½ç¬¬ä¸€å¼ å¡'; 
            } 
        });
        
        // æ´—ç‰ŒåŠŸèƒ½
        shuffleButton.addEventListener('click', () => { 
            if (isShuffling || gameState !== 'awaiting_draws') return; 
            const deck = cardDecks[currentActiveDeckName]; 
            if (!deck || deck.length === 0) { alert("å½“å‰ç‰Œç»„ä¸ºç©ºæˆ–æœªé€‰æ‹©ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®ï¼"); return; } 
            isShuffling = true; 
            
            drawCount++; 
            const randIndex = Math.floor(Math.random() * deck.length); 
            const drawnCard = deck[randIndex]; 
            
            const middleCard = cardStack.querySelector('.pos-middle'); 
            middleCard.querySelector('.card-content').textContent = drawnCard; 
            
            // ç”Ÿæˆæ—¶é—´æˆ³
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            cardStack.classList.add('is-shuffling'); 
            setTimeout(() => { 
                const topCard = cardStack.querySelector('.pos-top'); 
                const bottomCard = cardStack.querySelector('.pos-bottom'); 
                cardStack.classList.remove('is-shuffling'); 
                topCard.classList.remove('pos-top'); topCard.classList.add('pos-offscreen'); 
                middleCard.classList.remove('pos-middle'); middleCard.classList.add('pos-top'); 
                bottomCard.classList.remove('pos-bottom'); bottomCard.classList.add('pos-middle'); 
                topCard.querySelector('.card-content').textContent = ''; 
                cardStack.appendChild(topCard); 
                topCard.classList.remove('pos-offscreen'); topCard.classList.add('pos-bottom'); 
                isShuffling = false; 
                
                try {
                    // ä¿å­˜æ¶ˆæ¯æ—¶ä¸ä¼ é€’æ—¶é—´æˆ³ï¼ˆè‡ªä¸»æŠ½å¡æ—¶è§’è‰²å›å¤æ— æ—¶é—´æˆ³ï¼‰
                    // å¦‚æœè®¾ç½®äº†è§’è‰²å¼•ç”¨ï¼Œåˆ™ä½¿ç”¨å¼•ç”¨
                    addMessageToChat(currentChatCharacterId, 'character', drawnCard, null, null, characterQuotedMessageIndex);
                    // é‡ç½®è§’è‰²å¼•ç”¨
                    characterQuotedMessageIndex = null;
                    updateQuoteButtonState();
                    chatInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
                } catch(e) { console.error("ä¿å­˜æ¶ˆæ¯å¤±è´¥ï¼Œä½†ä¸ä¸­æ–­æ¸¸æˆ", e); }

                if (drawCount < maxDrawCount) { 
                    checkGameState(); 
                } else { 
                    gameState = 'can_ask'; 
                    checkGameState(); 
                    setTimeout(() => { cardStack.querySelector('.pos-top .card-content').textContent = 'è¯·å†æ¬¡æé—®'; }, 1500); 
                } 
            }, 350); 
        });
        
        // --- å¤šæ¡æ¶ˆæ¯åŠŸèƒ½ ---
        
        // æ˜¾ç¤ºå¤šæ¡æ¶ˆæ¯çª—å£
        function showMultiMessageWindow() {
            multiMessageWindow.style.display = 'flex';
            multiMessages = []; // æ¸…ç©ºæ¶ˆæ¯æ•°ç»„
            multiMessageInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            updateMultiMessageContent();
            multiMessageInput.focus();
        }
        
        // éšè—å¤šæ¡æ¶ˆæ¯çª—å£
        function hideMultiMessageWindow() {
            multiMessageWindow.style.display = 'none';
            multiMessages = []; // æ¸…ç©ºæ¶ˆæ¯æ•°ç»„
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°å¤šæ¡æ¶ˆæ¯åˆ—è¡¨
        function addMessageToMultiList() {
            const messageText = multiMessageInput.value.trim();
            if (!messageText) return;
            
            multiMessages.push(messageText);
            multiMessageInput.value = '';
            updateMultiMessageContent();
            multiMessageInput.focus();
        }
        
        // ä»å¤šæ¡æ¶ˆæ¯åˆ—è¡¨ä¸­åˆ é™¤æ¶ˆæ¯
        function removeMessageFromMultiList(index) {
            multiMessages.splice(index, 1);
            updateMultiMessageContent();
        }
        
        // æ›´æ–°å¤šæ¡æ¶ˆæ¯å†…å®¹æ˜¾ç¤º
        function updateMultiMessageContent() {
            multiMessageContent.innerHTML = '';
            
            if (multiMessages.length === 0) {
                multiMessageContent.innerHTML = '<p style="text-align: center; color: #aaa; padding: 10px;">æš‚æ— æ¶ˆæ¯ï¼Œè¯·æ·»åŠ </p>';
                return;
            }
            
            multiMessages.forEach((message, index) => {
                const messageItem = document.createElement('div');
                messageItem.className = 'multi-message-item';
                messageItem.innerHTML = `
                    <div class="multi-message-text">${message}</div>
                    <button class="multi-message-delete" data-index="${index}">&times;</button>
                `;
                multiMessageContent.appendChild(messageItem);
            });
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
            multiMessageContent.querySelectorAll('.multi-message-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    removeMessageFromMultiList(index);
                });
            });
        }
        
        // å‘é€å¤šæ¡æ¶ˆæ¯ï¼ˆå°†å¤šæ¡æ¶ˆæ¯ä½œä¸ºä¸€ç»„ç‹¬ç«‹æ¶ˆæ¯å‘é€ï¼Œç„¶åè§¦å‘ä¸€æ¬¡æŠ½å¡ï¼‰
        function sendMultiMessages() {
            if (multiMessages.length === 0) {
                alert('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€æ¡æ¶ˆæ¯');
                return;
            }
            
            if (!currentChatCharacterId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }
            
            // ç”ŸæˆåŸºç¡€æ—¶é—´æˆ³
            const baseTime = new Date();
            
            // ç¦ç”¨å‘é€æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤å‘é€
            multiMessageSendBtn.disabled = true;
            
            // ä¾æ¬¡å‘é€æ¯æ¡æ¶ˆæ¯
            let sentCount = 0;
            multiMessages.forEach((message, index) => {
                setTimeout(() => {
                    // ä¸ºæ¯æ¡æ¶ˆæ¯ç”Ÿæˆç¨å¾®ä¸åŒçš„æ—¶é—´æˆ³ï¼Œç¡®ä¿æ­£ç¡®çš„é¡ºåº
                    const messageTime = new Date(baseTime.getTime() + index * 500);
                    const timestamp = `${messageTime.getHours().toString().padStart(2, '0')}:${messageTime.getMinutes().toString().padStart(2, '0')}`;
                    
                    // å‘é€ç”¨æˆ·æ¶ˆæ¯
                    addMessageToChat(currentChatCharacterId, 'user', message, null, timestamp);
                    sentCount++;
                    
                    // å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œåˆ™åœ¨å‘é€åè§¦å‘æŠ½å¡
                    if (sentCount === multiMessages.length) {
                        setTimeout(() => {
                            // æ‰§è¡ŒæŠ½å¡é€»è¾‘
                            performChatDraw();
                            
                            // éšè—çª—å£å¹¶æ¸…ç©ºæ•°æ®
                            hideMultiMessageWindow();
                            
                            // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                            multiMessageSendBtn.disabled = false;
                        }, 500);
                    }
                }, index * 500); // æ¯æ¡æ¶ˆæ¯é—´éš”500ms
            });
        }
        
        // äº‹ä»¶ç›‘å¬
        chatMultiMessageBtn.addEventListener('click', showMultiMessageWindow);
        multiMessageClose.addEventListener('click', hideMultiMessageWindow);
        multiMessageAddBtn.addEventListener('click', addMessageToMultiList);
        multiMessageSendBtn.addEventListener('click', sendMultiMessages);
        
        // å¤šæ¡æ¶ˆæ¯è¾“å…¥æ¡†å›è½¦æ·»åŠ æ¶ˆæ¯
        multiMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addMessageToMultiList();
            }
        });
        
        // --- å…¶ä»–èŠå¤©åŠŸèƒ½ ---
        
        // æ‹ä¸€æ‹åŠŸèƒ½
        function sendPatMessage() {
            if (!currentChatCharacterId) return;
            
            // ç”Ÿæˆæ—¶é—´æˆ³
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            // å‘é€ç”¨æˆ·æ‹ä¸€æ‹æ¶ˆæ¯
            addMessageToChat(currentChatCharacterId, 'user', patSettings.userPatText, null, timestamp, null, true);
            
            // è§¦å‘æŠ½å¡
            performChatDraw();
        }
        
        // å¼•ç”¨å›å¤åŠŸèƒ½
        function setQuoteMessage() {
            if (selectedMessageIndices.size !== 1) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€æ¡æ¶ˆæ¯è¿›è¡Œå¼•ç”¨');
                return;
            }
            
            const selectedIndex = Array.from(selectedMessageIndices)[0];
            const history = chatHistory[currentChatCharacterId];
            const quotedMsg = history[selectedIndex];
            
            if (!quotedMsg) {
                alert('æ— æ³•æ‰¾åˆ°å¼•ç”¨çš„æ¶ˆæ¯');
                return;
            }
            
            quotedMessageIndex = selectedIndex;
            updateQuoteButtonState();
            
            // åœ¨è¾“å…¥æ¡†ä¸­æ˜¾ç¤ºå¼•ç”¨æç¤º
            const quoteText = quotedMsg.text.length > 30 ? quotedMsg.text.substring(0, 30) + '...' : quotedMsg.text;
            chatInput.placeholder = `å¼•ç”¨: ${quoteText}`;
            
            // é€€å‡ºé€‰æ‹©æ¨¡å¼
            exitSelectionMode();
            
            // èšç„¦åˆ°è¾“å…¥æ¡†
            chatInput.focus();
        }
        
        // æ›´æ–°å¼•ç”¨æŒ‰é’®çŠ¶æ€
        function updateQuoteButtonState() {
            if (quotedMessageIndex !== null) {
                chatQuoteBtn.textContent = 'ğŸ’¬';
                chatQuoteBtn.style.backgroundColor = '#ff5722';
            } else if (characterQuotedMessageIndex !== null) {
                chatQuoteBtn.textContent = 'ğŸ’¬';
                chatQuoteBtn.style.backgroundColor = '#4caf50';
            } else {
                chatQuoteBtn.textContent = 'ğŸ’¬';
                chatQuoteBtn.style.backgroundColor = 'transparent';
                chatInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
            }
        }
        
        // æ‰§è¡ŒæŠ½å¡é€»è¾‘
        function performChatDraw() {
            const deck = cardDecks[currentActiveDeckName]; 
            if (!deck || deck.length === 0) { 
                alert("å½“å‰ç‰Œç»„ä¸ºç©ºæˆ–æœªé€‰æ‹©ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®ï¼"); 
                return; 
            } 
            
            // æ ¹æ®éšæœºæ¨¡å¼ç¡®å®šæŠ½å¡æ¬¡æ•°
            const min = parseInt(minDrawCountInput.value);
            const max = parseInt(maxDrawCountInput.value);
            let drawCount;
            if (min >= 1 && max >= min && max <= 20) {
                drawCount = Math.floor(Math.random() * (max - min + 1)) + min;
            } else {
                drawCount = 1; // é»˜è®¤å€¼
            }
            
            // ç”ŸæˆåŸºç¡€æ—¶é—´æˆ³
            const baseTime = new Date();
            
            // æ‰§è¡ŒæŠ½å¡
            for (let i = 0; i < drawCount; i++) {
                setTimeout(() => {
                    const randIndex = Math.floor(Math.random() * deck.length); 
                    const drawnCard = deck[randIndex]; 
                    
                    // ä¸ºæ¯æ¡æ¶ˆæ¯ç”Ÿæˆç¨å¾®ä¸åŒçš„æ—¶é—´æˆ³ï¼Œç¡®ä¿æ­£ç¡®çš„é¡ºåº
                    const cardTime = new Date(baseTime.getTime() + (i + 1) * 1000); // æ¯æ¡æ¶ˆæ¯é—´éš”1ç§’
                    const timestamp = `${cardTime.getHours().toString().padStart(2, '0')}:${cardTime.getMinutes().toString().padStart(2, '0')}`;
                    
                    // æ·»åŠ è§’è‰²æ¶ˆæ¯ï¼Œå¦‚æœè®¾ç½®äº†è§’è‰²å¼•ç”¨ï¼Œåˆ™ä½¿ç”¨å¼•ç”¨
                    addMessageToChat(currentChatCharacterId, 'character', drawnCard, null, timestamp, characterQuotedMessageIndex);
                }, i * 800); // æ¯å¼ å¡é—´éš”800ms
            }
            
            // é‡ç½®è§’è‰²å¼•ç”¨
            characterQuotedMessageIndex = null;
            updateQuoteButtonState();
            chatInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
        }
        
        // äº‹ä»¶ç›‘å¬
        chatSendBtn.addEventListener('click', sendMessageAndDraw);
        chatQuoteBtn.addEventListener('click', setQuoteMessage);
        chatPatBtn.addEventListener('click', sendPatMessage);
        
        // è¾“å…¥æ¡†å›è½¦å‘é€
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessageAndDraw();
            }
        });
        
        // è§£å†³æ‰‹æœºè¾“å…¥æ¡†è·Ÿéšé”®ç›˜é«˜åº¦é—®é¢˜
        let viewport = window.visualViewport;
        if (viewport) {
            viewport.addEventListener('resize', function() {
                const chatInputArea = document.querySelector('.chat-input-area');
                if (chatInputArea) {
                    // å½“é”®ç›˜å¼¹å‡ºæ—¶ï¼Œè°ƒæ•´è¾“å…¥åŒºåŸŸä½ç½®
                    if (window.innerHeight > viewport.height) {
                        // é”®ç›˜å¼¹å‡º
                        chatInputArea.style.transform = `translateY(-${window.innerHeight - viewport.height}px)`;
                    } else {
                        // é”®ç›˜æ”¶èµ·
                        chatInputArea.style.transform = 'translateY(0)';
                    }
                }
            });
        }
        
        // --- çº¸æ¡AppåŠŸèƒ½ ---
        const notesAppMainView = document.getElementById('notes-app-main-view'); 
        const noteReplyView = document.getElementById('note-reply-view'); 
        const noteHistoryView = document.getElementById('note-history-view'); 
        const noteReplyContent = document.getElementById('note-reply-content'); 
        const noteReplyBackBtn = document.getElementById('note-reply-back-btn'); 
        const noteHistoryBtn = document.getElementById('note-history-btn'); 
        const noteHistoryBackBtn = document.getElementById('note-history-back-btn'); 
        const noteHistoryList = document.getElementById('note-history-list');
        const noteCharSelector = document.getElementById('note-char-selector'); 
        const noteUserInput = document.getElementById('note-user-input'); 
        const noteDrawCardBtn = document.getElementById('note-draw-card-btn'); 
        const noteDrawnCardsContainer = document.getElementById('note-drawn-cards-container'); 
        const noteDrawCardLabel = document.getElementById('note-draw-card-label'); 
        const noteGenerateBtn = document.getElementById('note-generate-btn');
        
        let noteCardDrawCount = 0; 
        let noteHistory = [];

        async function loadNoteHistory() { 
            noteHistory = await SimpleDB.get('data', 'noteHistory') || []; 
        }
        async function saveNoteHistory() { 
            await SimpleDB.set('data', 'noteHistory', noteHistory); 
        }

        function showNotesMainView() { 
            notesAppMainView.style.display = 'flex'; 
            noteReplyView.style.display = 'none'; 
            noteHistoryView.style.display = 'none'; 
        }
        
        function prepareNotesApp() { 
            showNotesMainView(); 
            noteCharSelector.innerHTML = ''; 
            const charKeys = Object.keys(characters); 
            if (charKeys.length === 0) { 
                const option = document.createElement('option'); 
                option.textContent = 'è¯·å…ˆå»"é€šè®¯"Appä¸­æ·»åŠ è§’è‰²'; 
                noteCharSelector.add(option); 
            } else { 
                charKeys.forEach(id => { 
                    const option = new Option(characters[id].name, id); 
                    noteCharSelector.add(option); 
                }); 
            } 
            noteUserInput.value = ''; 
            noteCardDrawCount = 0; 
            Array.from(noteDrawnCardsContainer.children).forEach(el => el.textContent = ''); 
            noteDrawCardLabel.textContent = `ä¸ºè¿™æ¬¡äº¤æ¢æŠ½å–ä¸»é¢˜å¡ (${noteCardDrawCount}/4):`; 
            noteGenerateBtn.textContent = 'ç”Ÿæˆå›ä¿¡';
            checkNotesButtonState(); 
        }

        function checkNotesButtonState() { 
            const hasChars = Object.keys(characters).length > 0; 
            const hasDeck = currentActiveDeckName && cardDecks[currentActiveDeckName] && cardDecks[currentActiveDeckName].length > 0; 
            noteDrawCardBtn.disabled = !hasChars || !hasDeck || noteCardDrawCount >= 4; 
            noteGenerateBtn.disabled = !hasChars || noteCardDrawCount < 4 || noteUserInput.value.trim() === ''; 
        }
        
        noteCharSelector.addEventListener('change', checkNotesButtonState); 
        noteUserInput.addEventListener('input', checkNotesButtonState);
        
        noteDrawCardBtn.addEventListener('click', () => { 
            if (noteCardDrawCount >= 4) return; 
            const deck = cardDecks[currentActiveDeckName]; 
            if (!deck || deck.length === 0) { 
                alert(`å½“å‰æ´»åŠ¨ç‰Œç»„"${currentActiveDeckName}"ä¸ºç©ºï¼Œè¯·å…ˆåœ¨æŠ½å¡Appçš„è®¾ç½®ä¸­æ·»åŠ å¡ç‰‡ï¼`); 
                return; 
            } 
            const randIndex = Math.floor(Math.random() * deck.length); 
            const drawnCard = deck[randIndex]; 
            const cardSlot = noteDrawnCardsContainer.children[noteCardDrawCount]; 
            cardSlot.textContent = drawnCard; 
            noteCardDrawCount++; 
            noteDrawCardLabel.textContent = `ä¸ºè¿™æ¬¡äº¤æ¢æŠ½å–ä¸»é¢˜å¡ (${noteCardDrawCount}/4):`; 
            checkNotesButtonState(); 
        });
        
        noteGenerateBtn.addEventListener('click', async () => { 
            const charId = noteCharSelector.value; 
            const character = characters[charId]; 
            if (!character) { 
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„è§’è‰²ã€‚'); 
                return; 
            } 
            const userNote = noteUserInput.value.trim(); 
            const drawnCards = Array.from(noteDrawnCardsContainer.children).map(el => el.textContent).filter(text => text); 
            const systemPrompt = `ä½ æ­£åœ¨æ‰®æ¼”ä¸€ä¸ªè§’è‰²ï¼Œä½ éœ€è¦æ ¹æ®ä½ çš„è§’è‰²è®¾å®šï¼Œå¯¹ç”¨æˆ·å†™ç»™ä½ çš„å°çº¸æ¡è¿›è¡Œå›å¤ã€‚å›å¤å†…å®¹éœ€è¦ç»“åˆæŠ½åˆ°çš„å¤šä¸ª"ä¸»é¢˜å­—å¡"ã€‚è¯·ç”¨äº²åˆ‡ã€ç¬¦åˆäººè®¾çš„å£å»ï¼Œå†™ä¸€å°å›ä¿¡ã€‚å›ä¿¡å†…å®¹æœ€å¤š100ä¸ªå­—ã€‚\nä½ çš„è§’è‰²è®¾å®šæ˜¯ï¼š${character.prompt || 'ä¸€ä¸ªæ¸©æŸ”çš„æœ‹å‹'}\n`; 
            const userPrompt = `è¿™æ˜¯æˆ‘å†™ç»™ä½ çš„å°çº¸æ¡å†…å®¹ï¼š\n---\n${userNote}\n---\næˆ‘ä»¬ä¸ºè¿™æ¬¡é€šä¿¡æŠ½åˆ°çš„ä¸»é¢˜å­—å¡æ˜¯ï¼šã€${drawnCards.join('ã€')}ã€‘\nç°åœ¨ï¼Œè¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šï¼Œç»™æˆ‘å†™ä¸€å°å›ä¿¡ã€‚`; 
            noteGenerateBtn.disabled = true; 
            noteGenerateBtn.textContent = 'æ­£åœ¨ç”Ÿæˆå›ä¿¡...'; 
            try { 
                const responseText = await callApi(systemPrompt, userPrompt); 
                const newRecord = { 
                    id: Date.now(), 
                    charId: charId, 
                    charName: character.name, 
                    userNote: userNote, 
                    drawnCards: drawnCards, 
                    reply: responseText, 
                    date: new Date().toLocaleString() 
                }; 
                noteHistory.unshift(newRecord); 
                saveNoteHistory(); 
                noteReplyContent.textContent = responseText; 
                notesAppMainView.style.display = 'none'; 
                noteReplyView.style.display = 'flex'; 
                noteReplyBackBtn.onclick = () => { 
                    prepareNotesApp(); 
                    showNotesMainView(); 
                }; 
            } catch (error) { 
                alert(`ç”Ÿæˆå¤±è´¥: ${error.message}`); 
                noteGenerateBtn.disabled = false; 
                noteGenerateBtn.textContent = 'ç”Ÿæˆå›ä¿¡'; 
            } 
        });
        
        noteHistoryBackBtn.addEventListener('click', showNotesMainView);
        
        noteHistoryBtn.addEventListener('click', () => { 
            notesAppMainView.style.display = 'none'; 
            noteHistoryView.style.display = 'flex'; 
            noteHistoryList.innerHTML = ''; 
            if (noteHistory.length === 0) { 
                noteHistoryList.innerHTML = '<li style="text-align: center; color: #999; padding: 20px;">è¿˜æ²¡æœ‰å†å²è®°å½•å“¦</li>'; 
                return; 
            } 
            noteHistory.forEach(record => { 
                const li = document.createElement('li'); 
                li.className = 'note-history-item'; 
                li.innerHTML = `
                    <div class="note-history-item-header">
                        <span class="note-history-char-name">${record.charName}</span>
                        <span class="note-history-date">${record.date}</span>
                    </div>
                    <p class="note-history-preview">${record.userNote || 'ï¼ˆæ— å†…å®¹ï¼‰'}</p>
                `; 
                li.addEventListener('click', () => { 
                    const fullNoteContent = `<b>ä½ çš„çº¸æ¡:</b>\n${record.userNote}\n\n<b>ä¸»é¢˜å¡:</b>\n${record.drawnCards.join(' / ')}\n\n<b>${record.charName}çš„å›ä¿¡:</b>\n${record.reply}`; 
                    noteReplyContent.innerHTML = fullNoteContent.replace(/\n/g, '<br>'); 
                    noteHistoryView.style.display = 'none'; 
                    noteReplyView.style.display = 'flex'; 
                    noteReplyBackBtn.onclick = () => { 
                        noteHistoryView.style.display = 'flex'; 
                        noteReplyView.style.display = 'none'; 
                    }; 
                }); 
                noteHistoryList.appendChild(li); 
            }); 
        });

        // åˆå§‹åŠ è½½
        setTimeout(() => { if (loadingEl.classList.contains('active')) { emergencyResetBtn.style.display = 'block'; } }, 3000);
        async function initialize() {
            try {
                await SimpleDB.open();
                await Promise.all([loadDecks(), loadChatData(), loadNoteHistory(), loadAppearanceSettings()]);
                loadApiSettings(); loadFontSettings(); loadFontSize(); loadDefaultDrawSettings(); loadAutoDrawSettings(); loadPatSettings();
                checkGameState();
                console.log("åˆå§‹åŒ–å®Œæˆï¼Œæ•°æ®åº“å·²è¿æ¥ã€‚");
            } catch (err) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", err);
                alert("åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·ç‚¹å‡»å±å¹•ä¸‹æ–¹çš„çº¢è‰²æŒ‰é’®é‡ç½®æ•°æ®ã€‚é”™è¯¯ï¼š" + err);
                emergencyResetBtn.style.display = 'block';
            } finally { hideLoading(); }
        }
        initialize();
    </script>
</body>
</html>